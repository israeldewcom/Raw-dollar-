<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChangeX EduSpace – Advanced Integrated Student Hub</title>
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js for advanced analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Animate.css for extra polish -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <style>
    /* ========== VARIABLES & RESET – refined palette & glassmorphism ========== */
    :root {
      --ink: #0b0e14;
      --ink-2: #161c28;
      --ink-3: #1f2738;
      --smoke: #f6f5f1;
      --smoke-2: #eae7de;
      --smoke-3: #d9d4c7;
      --lime: #b9f23e;
      --lime-dim: #8fbc1f;
      --teal: #00c9b1;
      --coral: #ff6b5c;
      --amber: #f7b731;
      --violet: #b48aff;
      --text-primary: #0b0e14;
      --text-secondary: #4d576b;
      --text-muted: #7e879b;
      --border: rgba(11,14,20,0.08);
      --border-strong: rgba(11,14,20,0.15);
      --radius: 16px;
      --radius-sm: 10px;
      --radius-lg: 24px;
      --shadow: 0 8px 24px rgba(0,0,0,0.04);
      --shadow-lg: 0 20px 48px rgba(0,0,0,0.12);
      --sidebar-w: 280px;
      --font-display: 'Syne', sans-serif;
      --font-body: 'DM Sans', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --transition: 0.25s cubic-bezier(0.2,0,0,1);
      --glass-bg: rgba(255,255,255,0.6);
      --glass-border: rgba(255,255,255,0.3);
    }
    [data-theme="dark"] {
      --ink: #f6f5f1;
      --ink-2: #eae7de;
      --ink-3: #d9d4c7;
      --smoke: #0b0e14;
      --smoke-2: #161c28;
      --smoke-3: #1f2738;
      --text-primary: #f0ede9;
      --text-secondary: #a6b0c2;
      --text-muted: #6b758b;
      --border: rgba(246,245,241,0.08);
      --border-strong: rgba(246,245,241,0.15);
      --shadow: 0 8px 24px rgba(0,0,0,0.5);
      --shadow-lg: 0 20px 48px rgba(0,0,0,0.7);
      --glass-bg: rgba(20,25,35,0.7);
      --glass-border: rgba(255,255,255,0.08);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: var(--font-body);
      background: var(--smoke);
      color: var(--text-primary);
      font-size: 15px;
      line-height: 1.6;
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden;
    }
    .app-shell { display: flex; min-height: 100vh; }
    /* ========== SIDEBAR – modern floating + backdrop ========== */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-right: 1px solid var(--glass-border);
      color: var(--text-primary);
      position: fixed;
      top: 0; left: 0; bottom: 0;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transform: translateX(0);
      transition: transform 0.3s var(--transition);
      overflow: hidden;
      box-shadow: 2px 0 20px rgba(0,0,0,0.05);
    }
    .sidebar.collapsed { transform: translateX(calc(-1 * var(--sidebar-w))); }
    .sidebar-brand {
      display: flex; align-items: center; gap: 12px;
      padding: 26px 20px 20px;
      border-bottom: 1px solid var(--border);
    }
    .brand-mark {
      width: 42px; height: 42px;
      background: var(--lime);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 6px 14px var(--lime-dim)30;
    }
    .brand-mark svg { width: 24px; height: 24px; fill: var(--ink); }
    .brand-name {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, var(--lime) 0%, var(--teal) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .brand-sub { font-size: 10px; color: var(--text-muted); letter-spacing: 0.8px; text-transform: uppercase; }
    .sidebar-search {
      padding: 16px 16px 8px;
      position: relative;
    }
    .sidebar-search input {
      width: 100%;
      background: var(--smoke-2);
      border: 1px solid var(--border);
      border-radius: 40px;
      padding: 10px 12px 10px 36px;
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 13px;
      outline: none;
      transition: all 0.2s;
    }
    .sidebar-search input:focus { border-color: var(--lime); box-shadow: 0 0 0 3px var(--lime-dim)20; }
    .sidebar-search-icon {
      position: absolute;
      left: 30px; top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 14px;
    }
    .sidebar-nav { flex: 1; overflow-y: auto; padding: 12px 0; scrollbar-width: thin; }
    .sidebar-nav::-webkit-scrollbar { width: 4px; }
    .sidebar-nav::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 8px; }
    .nav-section { margin-bottom: 6px; }
    .nav-section-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1.8px;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 16px 20px 6px;
    }
    .nav-item {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 16px;
      margin: 2px 10px;
      border-radius: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.18s;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      position: relative;
    }
    .nav-item:hover { background: var(--smoke-3); color: var(--text-primary); }
    .nav-item.active { 
      background: var(--lime); 
      color: var(--ink); 
      font-weight: 700;
      box-shadow: 0 8px 14px -6px var(--lime-dim);
    }
    .nav-item .nav-icon { width: 20px; font-size: 18px; text-align: center; flex-shrink: 0; }
    .nav-badge {
      margin-left: auto;
      background: var(--coral);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 40px;
      min-width: 20px;
      text-align: center;
    }
    .sidebar-user {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
      cursor: pointer;
      backdrop-filter: blur(8px);
    }
    .user-avatar {
      width: 44px; height: 44px;
      border-radius: 50%;
      background: linear-gradient(145deg, var(--teal), var(--violet));
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 16px; color: #fff;
      flex-shrink: 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .user-name { font-size: 14px; font-weight: 700; color: var(--text-primary); line-height: 1.2; }
    .user-role { font-size: 11px; color: var(--text-muted); text-transform: capitalize; }
    /* ========== MAIN CONTENT ========== */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-w);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: margin-left 0.3s;
    }
    .main-content.expanded { margin-left: 0; }
    .topbar {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--glass-border);
      padding: 0 28px;
      height: 70px;
      display: flex; align-items: center; gap: 20px;
      position: sticky; top: 0; z-index: 100;
    }
    .topbar-toggle {
      width: 42px; height: 42px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: transparent;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      transition: 0.2s;
    }
    .topbar-toggle:hover { background: var(--smoke-2); color: var(--text-primary); }
    .topbar-search {
      flex: 1;
      max-width: 420px;
      position: relative;
    }
    .topbar-search input {
      width: 100%;
      background: var(--smoke-2);
      border: 1px solid var(--border);
      border-radius: 40px;
      padding: 11px 16px 11px 44px;
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 14px;
      outline: none;
    }
    .topbar-search input:focus { border-color: var(--lime); box-shadow: 0 0 0 3px var(--lime-dim)20; }
    .topbar-search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    .topbar-actions { display: flex; align-items: center; gap: 12px; margin-left: auto; }
    .icon-btn {
      width: 44px; height: 44px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: transparent;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      position: relative;
      transition: 0.2s;
    }
    .icon-btn:hover { background: var(--smoke-2); color: var(--text-primary); transform: scale(1.02); }
    .icon-btn .badge-dot {
      position: absolute; top: 8px; right: 8px;
      width: 8px; height: 8px;
      background: var(--coral);
      border-radius: 50%;
      border: 2px solid var(--smoke);
    }
    .topbar-avatar {
      width: 44px; height: 44px;
      border-radius: 50%;
      background: linear-gradient(145deg, var(--teal), var(--violet));
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 15px; color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    /* ========== PAGE CONTAINER – smooth animations ========== */
    .page { display: none; padding: 28px; flex: 1; animation: fadeSlideUp 0.4s ease both; }
    .page.active { display: block; }
    @keyframes fadeSlideUp {
      0% { opacity: 0; transform: translateY(12px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .page-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 32px; gap: 16px;
      flex-wrap: wrap;
    }
    .page-title { font-family: var(--font-display); font-size: 32px; font-weight: 800; line-height: 1.1; background: linear-gradient(135deg, var(--lime), var(--teal)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .page-sub { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
    /* ========== CARDS & GRIDS – glassy ========== */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.3s;
      box-shadow: var(--shadow);
    }
    .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
    .stat-icon {
      width: 48px; height: 48px;
      border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px;
      margin-bottom: 16px;
      background: var(--smoke-2);
    }
    .stat-value { font-family: var(--font-display); font-size: 36px; font-weight: 700; line-height: 1; margin-bottom: 4px; }
    .stat-label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
    .stat-change {
      position: absolute;
      top: 20px; right: 20px;
      font-size: 12px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 30px;
    }
    .stat-change.up { background: rgba(185,242,62,0.15); color: var(--lime-dim); }
    .stat-change.down { background: rgba(255,107,92,0.1); color: var(--coral); }
    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }
    .card-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }
    .card-title { font-family: var(--font-display); font-size: 18px; font-weight: 700; }
    .card-body { padding: 24px; }
    .table-wrap { overflow-x: auto; }
    table.data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    table.data-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    table.data-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
      color: var(--text-primary);
    }
    table.data-table tr:hover td { background: var(--smoke-3); transition: 0.15s; }
    .badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 12px;
      border-radius: 40px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-success { background: rgba(0,201,177,0.1); color: var(--teal); }
    .badge-warning { background: rgba(247,183,49,0.1); color: var(--amber); }
    .badge-danger { background: rgba(255,107,92,0.1); color: var(--coral); }
    .badge-info { background: rgba(180,138,255,0.1); color: var(--violet); }
    .badge-neutral { background: var(--smoke-3); color: var(--text-secondary); }
    .badge-lime { background: rgba(185,242,62,0.15); color: var(--lime-dim); }
    .progress-bar-wrap { background: var(--smoke-3); border-radius: 30px; height: 8px; overflow: hidden; }
    .progress-bar-fill { height: 100%; border-radius: 30px; transition: width 1s ease; background: linear-gradient(90deg, var(--lime), var(--teal)); }
    .btn-primary-custom {
      background: linear-gradient(135deg, var(--lime), var(--teal));
      color: var(--ink);
      border: none;
      border-radius: 12px;
      padding: 10px 20px;
      font-family: var(--font-body);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 6px 14px rgba(0,201,177,0.2);
    }
    .btn-primary-custom:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(185,242,62,0.3); }
    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 9px 18px;
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-ghost:hover { background: var(--smoke-3); color: var(--text-primary); border-color: var(--border-strong); }
    .btn-danger {
      background: rgba(255,107,92,0.1);
      color: var(--coral);
      border: 1px solid rgba(255,107,92,0.2);
      border-radius: 12px;
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-danger:hover { background: var(--coral); color: #fff; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
    .grid-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
    .course-card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: transform 0.25s, box-shadow 0.3s;
      cursor: pointer;
    }
    .course-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-lg); }
    .course-card-thumb {
      height: 130px;
      display: flex; align-items: center; justify-content: center;
      font-size: 48px;
      background: linear-gradient(145deg, var(--lime)20, var(--teal)10);
    }
    .course-card-body { padding: 20px; }
    .course-card-code { font-family: var(--font-mono); font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
    .course-card-title { font-family: var(--font-display); font-size: 16px; font-weight: 700; line-height: 1.3; margin-bottom: 8px; }
    .course-card-footer {
      padding: 14px 20px;
      border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .form-group { margin-bottom: 20px; }
    .form-label { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; display: block; }
    .form-control-custom {
      width: 100%;
      background: var(--smoke);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 11px 16px;
      font-family: var(--font-body);
      font-size: 14px;
      color: var(--text-primary);
      outline: none;
      transition: 0.2s;
    }
    .form-control-custom:focus { border-color: var(--lime); box-shadow: 0 0 0 3px var(--lime-dim)20; }
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(8px);
      z-index: 2000;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
      padding: 16px;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal-box {
      background: var(--smoke);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 560px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      transform: scale(0.9) translateY(20px);
      transition: transform 0.3s;
    }
    .modal-overlay.open .modal-box { transform: scale(1) translateY(0); }
    .modal-header {
      padding: 22px 26px 16px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-title { font-family: var(--font-display); font-size: 20px; font-weight: 700; }
    .modal-close {
      width: 36px; height: 36px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: transparent;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--text-muted);
    }
    .modal-close:hover { background: var(--smoke-2); color: var(--text-primary); }
    .modal-body { padding: 24px 26px; }
    .modal-footer { padding: 16px 26px; border-top: 1px solid var(--border); display: flex; gap: 12px; justify-content: flex-end; }
    .notif-panel {
      position: fixed;
      top: 70px; right: 0;
      width: 380px;
      height: calc(100vh - 70px);
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-left: 1px solid var(--glass-border);
      z-index: 900;
      transform: translateX(100%);
      transition: transform 0.3s;
      display: flex; flex-direction: column;
      box-shadow: var(--shadow-lg);
    }
    .notif-panel.open { transform: translateX(0); }
    .notif-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .notif-title { font-family: var(--font-display); font-size: 18px; font-weight: 700; }
    .notif-list { flex: 1; overflow-y: auto; }
    .notif-item {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      display: flex; gap: 14px;
      cursor: pointer;
      transition: 0.15s;
    }
    .notif-item:hover { background: var(--smoke-3); }
    .notif-item.unread { background: rgba(185,242,62,0.05); }
    .notif-dot { width: 8px; height: 8px; background: var(--lime); border-radius: 50%; flex-shrink: 0; margin-top: 6px; }
    .notif-text { font-size: 14px; line-height: 1.5; color: var(--text-secondary); }
    .notif-time { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
    .toast-container {
      position: fixed; bottom: 28px; right: 28px; z-index: 9999;
      display: flex; flex-direction: column; gap: 12px;
    }
    .toast {
      background: var(--ink);
      color: #fff;
      padding: 14px 22px;
      border-radius: 14px;
      display: flex; align-items: center; gap: 12px;
      min-width: 300px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
      animation: slideInRight 0.3s forwards;
      font-size: 14px;
      border-left: 6px solid var(--lime);
    }
    .toast.error { border-left-color: var(--coral); }
    .toast.warning { border-left-color: var(--amber); }
    .toast.info { border-left-color: var(--teal); }
    .toast.out { animation: slideOutRight 0.2s ease-in forwards; }
    @keyframes slideInRight {
      0% { opacity: 0; transform: translateX(40px); }
      100% { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideOutRight {
      to { opacity: 0; transform: translateX(40px); }
    }
    .toggle-switch { position: relative; width: 44px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-track {
      position: absolute; inset: 0;
      background: var(--smoke-3);
      border-radius: 40px;
      cursor: pointer;
      transition: 0.2s;
    }
    .toggle-switch input:checked + .toggle-track { background: var(--lime); }
    .toggle-track::after {
      content: '';
      position: absolute;
      top: 3px; left: 3px;
      width: 18px; height: 18px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.25s;
    }
    .toggle-switch input:checked + .toggle-track::after { transform: translateX(20px); }
    .automation-log {
      background: var(--smoke-3);
      border-radius: 12px;
      padding: 16px;
      font-family: var(--font-mono);
      font-size: 12px;
      max-height: 250px;
      overflow-y: auto;
      margin-top: 12px;
    }
    .automation-log div { padding: 6px 0; border-bottom: 1px dashed var(--border); }
    .skeleton-loading { padding: 30px; text-align: center; color: var(--text-muted); }
    .loading-spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--lime);
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .empty-state { padding: 40px; text-align: center; color: var(--text-muted); font-style: italic; }
    .mt-3 { margin-top: 16px; }
    .mb-2 { margin-bottom: 8px; }
    .ms-2 { margin-left: 8px; }
    .me-2 { margin-right: 8px; }
    .w-100 { width: 100%; }
    .d-flex { display: flex; }
    .align-items-center { align-items: center; }
    .justify-content-between { justify-content: space-between; }
    @media (max-width: 900px) {
      .sidebar { transform: translateX(calc(-1 * var(--sidebar-w))); }
      .sidebar.mobile-open { transform: translateX(0); }
      .main-content { margin-left: 0 !important; }
      .notif-panel { width: 100%; }
    }
  </style>
</head>
<body>
<div class="app-shell" id="appShell">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <div class="brand-mark">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      </div>
      <div>
        <div class="brand-name">ChangeX</div>
        <div class="brand-sub">EduSpace</div>
      </div>
    </div>
    <div class="sidebar-search">
      <i class="bi bi-search sidebar-search-icon"></i>
      <input type="text" placeholder="Quick search..." id="sidebarSearchInput" onkeydown="if(event.key==='Enter') globalSearch(this.value)">
    </div>
    <nav class="sidebar-nav" id="sidebarNav"></nav>
    <div class="sidebar-user" onclick="navigateTo('profile')">
      <div class="user-avatar" id="sidebarAvatar">MS</div>
      <div>
        <div class="user-name" id="sidebarName">Maria Santos</div>
        <div class="user-role" id="sidebarRole">student</div>
      </div>
      <i class="bi bi-chevron-right" style="margin-left:auto;color:var(--text-muted);"></i>
    </div>
  </aside>

  <div class="main-content" id="mainContent">
    <header class="topbar">
      <button class="topbar-toggle" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
      <div class="topbar-search">
        <i class="bi bi-search topbar-search-icon"></i>
        <input type="text" placeholder="Search courses, assignments..." id="globalSearchInput" onkeydown="if(event.key==='Enter') globalSearch(this.value)">
      </div>
      <div class="topbar-actions">
        <button class="icon-btn" onclick="toggleTheme()" id="themeBtn"><i class="bi bi-moon"></i></button>
        <button class="icon-btn" onclick="toggleNotifPanel()"><i class="bi bi-bell"></i><span class="badge-dot" id="notifDot"></span></button>
        <button class="icon-btn" onclick="showHelp()"><i class="bi bi-question-circle"></i></button>
        <div class="topbar-avatar" onclick="navigateTo('profile')" id="topbarAvatar">MS</div>
      </div>
    </header>

    <!-- Dynamic page container -->
    <div id="pageContainer"></div>
  </div>
</div>

<!-- Notification Panel -->
<div class="notif-panel" id="notifPanel">
  <div class="notif-header">
    <div class="notif-title">Notifications</div>
    <button class="btn-ghost" style="font-size:12px;" onclick="markAllNotificationsRead()">Mark all read</button>
  </div>
  <div class="notif-list" id="notifList"></div>
</div>

<!-- Generic Modal -->
<div class="modal-overlay" id="genericModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Modal Title</div>
      <button class="modal-close" onclick="closeModal('genericModal')"><i class="bi bi-x"></i></button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer" id="modalFooter"></div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
  (function() {
    // ========== STORAGE KEYS & INITIAL STATE – same as original, extended ==========
    const STORAGE_KEYS = {
      USERS: 'changex_users',
      INSTITUTIONS: 'changex_institutions',
      COURSES: 'changex_courses',
      ASSIGNMENTS: 'changex_assignments',
      SUBMISSIONS: 'changex_submissions',
      ATTENDANCE: 'changex_attendance',
      PAYMENTS: 'changex_payments',
      MESSAGES: 'changex_messages',
      NOTIFICATIONS: 'changex_notifications',
      LIVE_SESSIONS: 'changex_live_sessions',
      EXAM_SESSIONS: 'changex_exam_sessions',
      PROCTORING_LOGS: 'changex_proctoring_logs',
      POLICIES: 'changex_policies',
      PROGRAMMES: 'changex_programmes',
      ADMISSIONS: 'changex_admissions',
      HOSTEL_APPLICATIONS: 'changex_hostel_applications',
      LIBRARY_RESOURCES: 'changex_library_resources',
      BORROWING_RECORDS: 'changex_borrowing_records',
      STAFF_PROFILES: 'changex_staff_profiles',
      ALUMNI: 'changex_alumni',
      ACADEMIC_CALENDAR: 'changex_academic_calendar',
      SETTINGS: 'changex_settings',
      AUDIT_LOG: 'changex_audit_log',
      CURRENT_USER: 'changex_currentUser',
      THEME: 'changex_theme',
      SIDEBAR: 'changex_sidebar',
      AUTOMATION_LOGS: 'changex_automation_logs'
    };

    function getStorage(key, defaultValue) {
      try { return JSON.parse(localStorage.getItem(key)) || defaultValue; } catch { return defaultValue; }
    }
    function setStorage(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

    // ---------- DEFAULT DATA – enriched with staff, alumni, calendar, policies ----------
    const DEFAULT_USERS = [
      { id: 1, name: 'Admin User', email: 'admin@changex.com', password: 'admin123', role: 'admin', institutionId: 1, lastLogin: new Date().toISOString(), active: true, initials: 'AU', phone: '', preferences: { email: true, sms: false }, avatar: null },
      { id: 2, name: 'Maria Santos', email: 'm.santos@metro.edu', password: 'student123', role: 'student', institutionId: 1, lastLogin: new Date().toISOString(), active: true, initials: 'MS', phone: '+1234567890', preferences: { email: true, sms: false }, matricNumber: 'MT2024001', programmeId: 1, admissionYear: 2024 },
      { id: 3, name: 'Prof. John Liu', email: 'faculty@changex.com', password: 'faculty123', role: 'faculty', institutionId: 1, lastLogin: new Date().toISOString(), active: true, initials: 'JL', phone: '', preferences: { email: true, sms: false } },
      { id: 4, name: 'Parent One', email: 'parent@example.com', password: 'parent123', role: 'parent', institutionId: 1, lastLogin: new Date().toISOString(), active: true, initials: 'PO', phone: '', children: [2] }
    ];

    const DEFAULT_INSTITUTIONS = [
      { id: 1, name: 'Metro University', type: 'university', domain: 'metro.edu', tier: 'enterprise', status: 'active', settings: { timezone: 'UTC', language: 'en' }, created: '2023-01-01' }
    ];

    const DEFAULT_COURSES = [
      { id: 1, code: 'CS301', title: 'Advanced Algorithms', description: 'Advanced algorithms and data structures.', credits: 3, institutionId: 1, departmentId: 1, instructorId: 3, capacity: 30, enrolled: 28, status: 'active', submittedForApproval: true, approved: true, syllabus: 'Topics: NP-completeness, dynamic programming, graph algorithms.' },
      { id: 2, code: 'BIO101', title: 'Introduction to Biology', description: 'Basics of cellular biology.', credits: 3, institutionId: 1, departmentId: 2, instructorId: 5, capacity: 30, enrolled: 24, status: 'active', submittedForApproval: true, approved: true, syllabus: 'Cell structure, DNA, proteins.' }
    ];

    const DEFAULT_ASSIGNMENTS = [
      { id: 1, title: 'Algorithm Analysis Essay', description: 'Write an essay on algorithm complexity.', courseId: 1, dueDate: '2025-06-15T23:59:59Z', points: 100, submissionType: 'file', allowedFileTypes: ['pdf','docx'], isExam: false, latePolicy: 'allowed_with_penalty' },
      { id: 2, title: 'Cell Biology Lab Report', courseId: 2, dueDate: '2025-06-12T23:59:59Z', points: 50, submissionType: 'file', isExam: false, latePolicy: 'not_allowed' },
      { id: 3, title: 'Midterm Exam', courseId: 1, dueDate: '2025-06-20T10:00:00Z', points: 200, isExam: true, durationMinutes: 120, proctoringRequired: true, questions: [
        { text: 'Explain NP-completeness.', type: 'essay' },
        { text: 'Solve recurrence T(n)=2T(n/2)+n.', type: 'text' }
      ]}
    ];

    const DEFAULT_SUBMISSIONS = [
      { id: 1, assignmentId: 1, userId: 2, fileUrl: null, text: 'My essay on algorithms...', submittedAt: '2025-06-14T10:00:00Z', grade: 85, feedback: 'Good work, but missing some edge cases.', gradedAt: '2025-06-16T14:00:00Z', status: 'graded' },
      { id: 2, assignmentId: 2, userId: 2, fileUrl: 'submissions/bio_lab.pdf', text: null, submittedAt: '2025-06-11T09:30:00Z', grade: 42, feedback: 'Needs more details.', gradedAt: '2025-06-13T11:00:00Z', status: 'graded' }
    ];

    const DEFAULT_ATTENDANCE = [
      { id: 1, courseOfferingId: 1, userId: 2, date: '2025-05-10', status: 'present' },
      { id: 2, courseOfferingId: 1, userId: 2, date: '2025-05-12', status: 'late' },
      { id: 3, courseOfferingId: 1, userId: 2, date: '2025-05-17', status: 'present' }
    ];

    const DEFAULT_PAYMENTS = [
      { id: 'pay_001', userId: 2, institutionId: 1, amount: 2400, description: 'Spring Semester Tuition', status: 'completed', date: '2025-01-15T00:00:00Z', paystackReference: 'ref_123' }
    ];

    const DEFAULT_MESSAGES = [
      { id: 1, fromUserId: 3, toUserId: 2, subject: 'CS301 Midterm Review', body: 'Reminder: review session tomorrow at 3pm.', time: new Date().toISOString(), read: false },
      { id: 2, fromUserId: 1, toUserId: 2, subject: 'Welcome', body: 'Welcome to the portal!', time: new Date(Date.now()-86400000).toISOString(), read: true }
    ];

    const DEFAULT_NOTIFICATIONS = [
      { id: 1, userId: 2, text: 'New grade posted for CS301', time: new Date().toISOString(), read: false }
    ];

    const DEFAULT_LIVE_SESSIONS = [
      { id: 1, courseId: 1, title: 'Algorithms Q&A', startTime: new Date(Date.now()+3600000).toISOString(), duration: 60, joinUrl: 'https://meet.changex.com/algo', instructorId: 3 }
    ];

    const DEFAULT_EXAM_SESSIONS = [];
    const DEFAULT_PROCTORING_LOGS = [];

    const DEFAULT_POLICIES = [
      { id: 1, institutionId: 1, type: 'privacy', content: 'We respect your privacy.', version: 1, active: true }
    ];

    const DEFAULT_PROGRAMMES = [
      { id: 1, institutionId: 1, name: 'Computer Science', code: 'CS', departmentId: 1, durationYears: 4, requirements: 'Math, Programming' }
    ];

    const DEFAULT_ADMISSIONS = [
      { id: 1, userId: 2, programmeId: 1, status: 'accepted', applicationDate: '2024-01-15', decisionDate: '2024-03-01' }
    ];
    const DEFAULT_HOSTEL_APPLICATIONS = [
      { id: 1, userId: 2, hostelName: 'Hall A', roomType: 'shared', status: 'approved', allocatedRoom: 'A-101', applicationDate: '2025-02-01' }
    ];
    const DEFAULT_LIBRARY_RESOURCES = [
      { id: 1, institutionId: 1, title: 'Introduction to Algorithms', author: 'Cormen', isbn: '9780262033848', type: 'book', location: 'Library A', copiesTotal: 5, copiesAvailable: 3 },
      { id: 2, title: 'Cell Biology', author: 'Alberts', copiesTotal: 2, copiesAvailable: 1 }
    ];
    const DEFAULT_BORROWING_RECORDS = [
      { id: 1, userId: 2, resourceId: 1, borrowedAt: '2025-05-01', dueDate: '2025-05-15', returnedAt: null, fine: 0 }
    ];
    const DEFAULT_STAFF_PROFILES = [
      { id: 1, userId: 3, title: 'Professor', department: 'Computer Science', office: 'CS-205', email: 'j.liu@metro.edu' }
    ];
    const DEFAULT_ALUMNI = [
      { id: 1, name: 'Alice Johnson', graduationYear: 2023, programme: 'CS' }
    ];
    const DEFAULT_ACADEMIC_CALENDAR = [
      { id: 1, institutionId: 1, event: 'Spring Break', start: '2025-03-10', end: '2025-03-17' },
      { id: 2, institutionId: 1, event: 'Final Exams', start: '2025-06-20', end: '2025-06-28' }
    ];
    const DEFAULT_SETTINGS = { env: 'production', debug: false, pageSize: 20, features: { predictive: true, realtime: true, video: true, proctoring: true, paystack: true } };
    const DEFAULT_AUDIT_LOG = [];
    const DEFAULT_AUTOMATION_LOGS = [];

    // Global state
    let state = {
      users: getStorage(STORAGE_KEYS.USERS, DEFAULT_USERS),
      institutions: getStorage(STORAGE_KEYS.INSTITUTIONS, DEFAULT_INSTITUTIONS),
      courses: getStorage(STORAGE_KEYS.COURSES, DEFAULT_COURSES),
      assignments: getStorage(STORAGE_KEYS.ASSIGNMENTS, DEFAULT_ASSIGNMENTS),
      submissions: getStorage(STORAGE_KEYS.SUBMISSIONS, DEFAULT_SUBMISSIONS),
      attendance: getStorage(STORAGE_KEYS.ATTENDANCE, DEFAULT_ATTENDANCE),
      payments: getStorage(STORAGE_KEYS.PAYMENTS, DEFAULT_PAYMENTS),
      messages: getStorage(STORAGE_KEYS.MESSAGES, DEFAULT_MESSAGES),
      notifications: getStorage(STORAGE_KEYS.NOTIFICATIONS, DEFAULT_NOTIFICATIONS),
      liveSessions: getStorage(STORAGE_KEYS.LIVE_SESSIONS, DEFAULT_LIVE_SESSIONS),
      examSessions: getStorage(STORAGE_KEYS.EXAM_SESSIONS, DEFAULT_EXAM_SESSIONS),
      proctoringLogs: getStorage(STORAGE_KEYS.PROCTORING_LOGS, DEFAULT_PROCTORING_LOGS),
      policies: getStorage(STORAGE_KEYS.POLICIES, DEFAULT_POLICIES),
      programmes: getStorage(STORAGE_KEYS.PROGRAMMES, DEFAULT_PROGRAMMES),
      admissions: getStorage(STORAGE_KEYS.ADMISSIONS, DEFAULT_ADMISSIONS),
      hostelApplications: getStorage(STORAGE_KEYS.HOSTEL_APPLICATIONS, DEFAULT_HOSTEL_APPLICATIONS),
      libraryResources: getStorage(STORAGE_KEYS.LIBRARY_RESOURCES, DEFAULT_LIBRARY_RESOURCES),
      borrowingRecords: getStorage(STORAGE_KEYS.BORROWING_RECORDS, DEFAULT_BORROWING_RECORDS),
      staffProfiles: getStorage(STORAGE_KEYS.STAFF_PROFILES, DEFAULT_STAFF_PROFILES),
      alumni: getStorage(STORAGE_KEYS.ALUMNI, DEFAULT_ALUMNI),
      academicCalendar: getStorage(STORAGE_KEYS.ACADEMIC_CALENDAR, DEFAULT_ACADEMIC_CALENDAR),
      settings: getStorage(STORAGE_KEYS.SETTINGS, DEFAULT_SETTINGS),
      auditLog: getStorage(STORAGE_KEYS.AUDIT_LOG, DEFAULT_AUDIT_LOG),
      automationLogs: getStorage(STORAGE_KEYS.AUTOMATION_LOGS, DEFAULT_AUTOMATION_LOGS),
      currentUser: getStorage(STORAGE_KEYS.CURRENT_USER, DEFAULT_USERS[1]),  // default student
      theme: localStorage.getItem(STORAGE_KEYS.THEME) || 'light',
      sidebarOpen: localStorage.getItem(STORAGE_KEYS.SIDEBAR) !== 'false'
    };

    function persist(key) { setStorage(key, state[key]); }
    function logAudit(action, details) {
      const entry = { id: Date.now(), user: state.currentUser?.name || 'system', action, details, timestamp: new Date().toISOString() };
      state.auditLog.unshift(entry);
      if (state.auditLog.length > 200) state.auditLog.pop();
      persist(STORAGE_KEYS.AUDIT_LOG);
    }

    // ========== AUTHENTICATION – same logic ==========
    function checkAuth() {
      if (!state.currentUser) {
        showLoginPage();
        return false;
      }
      return true;
    }

    function showLoginPage() {
      const container = document.getElementById('pageContainer');
      container.innerHTML = `
        <div class="page active" style="display:flex; align-items:center; justify-content:center; min-height:80vh;">
          <div class="card" style="max-width:400px; width:100%;">
            <div class="card-header"><div class="card-title">Login to ChangeX</div></div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input class="form-control-custom" id="loginEmail" value="m.santos@metro.edu">
              </div>
              <div class="form-group">
                <label class="form-label">Password</label>
                <input class="form-control-custom" type="password" id="loginPassword" value="student123">
              </div>
              <button class="btn-primary-custom" style="width:100%;" onclick="login()">Login</button>
              <p class="mt-3 text-center"><a href="#" onclick="showRegister()">Register</a></p>
            </div>
          </div>
        </div>
      `;
    }

    window.login = function() {
      const email = document.getElementById('loginEmail').value;
      const pwd = document.getElementById('loginPassword').value;
      const user = state.users.find(u => u.email === email && u.password === pwd);
      if (user) {
        state.currentUser = user;
        setStorage(STORAGE_KEYS.CURRENT_USER, user);
        logAudit('login', `User ${user.email} logged in`);
        updateUserSidebar();
        renderSidebarNav();
        navigateTo('dashboard');
      } else {
        showToast('Invalid credentials', 'error');
      }
    };

    window.showRegister = function() {
      const container = document.getElementById('pageContainer');
      container.innerHTML = `
        <div class="page active" style="display:flex; align-items:center; justify-content:center; min-height:80vh;">
          <div class="card" style="max-width:400px;">
            <div class="card-header"><div class="card-title">Register</div></div>
            <div class="card-body">
              <div class="form-group"><label class="form-label">Name</label><input class="form-control-custom" id="regName"></div>
              <div class="form-group"><label class="form-label">Email</label><input class="form-control-custom" id="regEmail"></div>
              <div class="form-group"><label class="form-label">Password</label><input class="form-control-custom" type="password" id="regPassword"></div>
              <button class="btn-primary-custom" style="width:100%;" onclick="register()">Register</button>
              <p class="mt-3 text-center"><a href="#" onclick="showLoginPage()">Back to login</a></p>
            </div>
          </div>
        </div>
      `;
    };

    window.register = function() {
      const name = document.getElementById('regName').value;
      const email = document.getElementById('regEmail').value;
      const pwd = document.getElementById('regPassword').value;
      if (!name || !email || !pwd) { showToast('All fields required', 'error'); return; }
      const newId = Math.max(...state.users.map(u=>u.id),0)+1;
      const user = {
        id: newId,
        name, email, password: pwd,
        role: 'student',
        institutionId: 1,
        active: true,
        initials: name.split(' ').map(n=>n[0]).join('').toUpperCase(),
        preferences: { email: true, sms: false },
        created: new Date().toISOString()
      };
      state.users.push(user);
      persist(STORAGE_KEYS.USERS);
      showToast('Registration successful, please login');
      showLoginPage();
    };

    // ========== ROLE PERMISSIONS – extended with new pages ==========
    const rolePermissions = {
      super_admin: ['dashboard', 'institutions', 'users', 'courses', 'assignments', 'grades', 'attendance', 'messages', 'live-class', 'exams', 'bursary', 'hostel', 'library', 'curriculum', 'automation', 'integrations', 'settings', 'health', 'gdpr-export', 'profile', 'analytics', 'staff', 'alumni', 'calendar', 'policies', 'admissions'],
      admin: ['dashboard', 'institutions', 'users', 'courses', 'assignments', 'grades', 'attendance', 'messages', 'live-class', 'exams', 'bursary', 'hostel', 'library', 'curriculum', 'automation', 'integrations', 'settings', 'health', 'gdpr-export', 'profile', 'analytics', 'staff', 'alumni', 'calendar', 'policies', 'admissions'],
      faculty: ['dashboard', 'courses', 'assignments', 'grades', 'attendance', 'messages', 'live-class', 'exams', 'profile', 'student-profile', 'staff', 'calendar'],
      student: ['dashboard', 'courses', 'assignments', 'grades', 'attendance', 'messages', 'live-class', 'exams', 'bursary', 'hostel', 'library', 'curriculum', 'profile', 'gdpr-export', 'calendar', 'policies', 'admissions', 'alumni'],
      parent: ['dashboard', 'grades', 'attendance', 'messages', 'profile', 'student-profile', 'bursary']
    };

    function userCanViewPage(page) {
      return state.currentUser && rolePermissions[state.currentUser.role]?.includes(page);
    }

    // ========== RENDER SIDEBAR – with new sections ==========
    function renderSidebarNav() {
      const nav = document.getElementById('sidebarNav');
      const role = state.currentUser?.role;
      const pages = rolePermissions[role] || [];
      const sections = [
        { label: 'Overview', pages: ['dashboard', 'analytics'] },
        { label: 'Academic', pages: ['courses', 'assignments', 'grades', 'attendance', 'exams', 'curriculum'] },
        { label: 'Services', pages: ['bursary', 'hostel', 'library', 'live-class'] },
        { label: 'Community', pages: ['staff', 'alumni', 'calendar', 'policies'] },
        { label: 'System', pages: ['messages', 'automation', 'integrations', 'settings', 'health', 'gdpr-export', 'profile'] },
        { label: 'Admin', pages: ['institutions', 'users', 'admissions'] }
      ];
      let html = '';
      sections.forEach(section => {
        const visible = section.pages.filter(p => pages.includes(p));
        if (!visible.length) return;
        html += `<div class="nav-section"><div class="nav-section-label">${section.label}</div>`;
        visible.forEach(page => {
          let badge = '';
          if (page === 'messages') {
            const unread = state.messages.filter(m => !m.read && m.toUserId === state.currentUser?.id).length;
            if (unread) badge = `<span class="nav-badge">${unread}</span>`;
          }
          html += `<a class="nav-item" onclick="navigateTo('${page}')"><i class="bi ${getIcon(page)} nav-icon"></i> ${capitalize(page)} ${badge}</a>`;
        });
        html += '</div>';
      });
      nav.innerHTML = html;
    }

    function getIcon(p) {
      const icons = {
        dashboard:'bi-grid', courses:'bi-book', assignments:'bi-file-text', grades:'bi-award', attendance:'bi-calendar-check',
        messages:'bi-chat', profile:'bi-person', exams:'bi-pencil', bursary:'bi-cash', hostel:'bi-door-open',
        library:'bi-book', 'live-class':'bi-camera-video', curriculum:'bi-diagram-3', automation:'bi-lightning',
        integrations:'bi-puzzle', settings:'bi-gear', health:'bi-heart', 'gdpr-export':'bi-shield', institutions:'bi-building',
        users:'bi-people', analytics:'bi-graph-up', staff:'bi-people-fill', alumni:'bi-award-fill', calendar:'bi-calendar-event',
        policies:'bi-file-earmark-text', admissions:'bi-envelope-paper'
      };
      return icons[p] || 'bi-circle';
    }
    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1).replace(/-/g,' '); }

    // ========== NAVIGATION – same ==========
    window.navigateTo = function(page, param) {
      if (!checkAuth()) return;
      if (!userCanViewPage(page)) { showToast('Access denied', 'error'); return; }
      const container = document.getElementById('pageContainer');
      container.innerHTML = '<div class="skeleton-loading"><div class="loading-spinner mx-auto"></div><p>Loading...</p></div>';
      setTimeout(() => {
        const pageDiv = document.createElement('div');
        pageDiv.className = 'page active';
        pageDiv.id = 'page-' + page;
        container.innerHTML = '';
        container.appendChild(pageDiv);
        window.location.hash = page + (param ? '/' + param : '');
        renderPage(page, param, pageDiv);
      }, 100);
    };

    function renderPage(page, param, container) {
      const pages = {
        dashboard: renderDashboard,
        courses: renderCourses,
        assignments: renderAssignments,
        grades: renderGrades,
        attendance: renderAttendance,
        messages: renderMessages,
        profile: renderProfile,
        'live-class': renderLiveClass,
        exams: renderExams,
        bursary: renderBursary,
        hostel: renderHostel,
        library: renderLibrary,
        curriculum: renderCurriculum,
        automation: renderAutomation,
        integrations: renderIntegrations,
        settings: renderSettings,
        health: renderHealth,
        'gdpr-export': renderGDPRExport,
        institutions: renderInstitutions,
        users: renderUsers,
        analytics: renderAnalytics,
        staff: renderStaff,
        alumni: renderAlumni,
        calendar: renderCalendar,
        policies: renderPolicies,
        admissions: renderAdmissions,
        'course-detail': renderCourseDetail,
        'assignment-detail': renderAssignmentDetail
      };
      if (pages[page]) pages[page](container, param);
      else container.innerHTML = '<h1>Page not found</h1>';
    }

    // ========== PAGE RENDERERS – upgraded with more features ==========
    function renderDashboard(container) {
      const user = state.currentUser;
      const myCourses = state.courses.filter(c => c.enrolled > 0);
      const upcomingAssignments = state.assignments.filter(a => new Date(a.dueDate) > new Date() && a.courseId && myCourses.some(c => c.id === a.courseId)).slice(0,5);
      const avgGrade = state.submissions.filter(s => s.userId === user.id && s.grade).reduce((acc,s,_,arr) => acc + s.grade/arr.length, 0) || 0;
      const attendanceRate = state.attendance.filter(a => a.userId === user.id).length ? (state.attendance.filter(a => a.userId === user.id && a.status==='present').length / state.attendance.filter(a => a.userId === user.id).length * 100).toFixed(0) : 0;
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Welcome back, ${user.name}</h1><span class="badge badge-lime">Last login: ${new Date(user.lastLogin).toLocaleString()}</span></div>
        <div class="stat-grid">
          <div class="stat-card animate__animated animate__fadeInUp"><div class="stat-icon"><i class="bi bi-book"></i></div><div class="stat-value">${myCourses.length}</div><div class="stat-label">Enrolled Courses</div></div>
          <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay:0.1s"><div class="stat-icon"><i class="bi bi-calendar-check"></i></div><div class="stat-value">${upcomingAssignments.length}</div><div class="stat-label">Upcoming Assignments</div></div>
          <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay:0.2s"><div class="stat-icon"><i class="bi bi-trophy"></i></div><div class="stat-value">${avgGrade.toFixed(0)}%</div><div class="stat-label">Average Grade</div></div>
          <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay:0.3s"><div class="stat-icon"><i class="bi bi-person"></i></div><div class="stat-value">${attendanceRate}%</div><div class="stat-label">Attendance</div></div>
        </div>
        <div class="grid-2-1">
          <div class="card"><div class="card-header"><div class="card-title">My Courses</div><button class="btn-ghost" onclick="navigateTo('courses')">View all</button></div><div class="card-body">${myCourses.map(c => `<div class="d-flex justify-content-between mb-2"><span><strong>${c.code}</strong> – ${c.title}</span><span class="badge badge-success">${c.enrolled}/${c.capacity}</span></div>`).join('')}</div></div>
          <div class="card"><div class="card-header"><div class="card-title">Upcoming Deadlines</div></div><div class="card-body">${upcomingAssignments.length ? upcomingAssignments.map(a => `<div class="d-flex justify-content-between mb-2"><span>${a.title}</span><small class="text-muted">${new Date(a.dueDate).toLocaleDateString()}</small></div>`).join('') : '<p class="text-muted">No upcoming deadlines</p>'}</div></div>
        </div>
      `;
    }

    function renderCourses(container) {
      const isFaculty = state.currentUser.role === 'faculty' || state.currentUser.role === 'admin';
      const courses = state.courses;
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Courses</h1>${isFaculty ? '<button class="btn-primary-custom" onclick="openCourseModal()">+ New Course</button>' : ''}</div>
        <div class="grid-3" id="courseGrid">
          ${courses.map(c => `
            <div class="course-card" onclick="navigateTo('course-detail', ${c.id})">
              <div class="course-card-thumb">📘</div>
              <div class="course-card-body">
                <div class="course-card-code">${c.code}</div>
                <div class="course-card-title">${c.title}</div>
                <div>Instructor: ${state.users.find(u => u.id === c.instructorId)?.name || 'TBA'}</div>
              </div>
              <div class="course-card-footer">
                <span><i class="bi bi-people"></i> ${c.enrolled}/${c.capacity}</span>
                <span class="badge ${c.enrolled >= c.capacity ? 'badge-warning' : 'badge-success'}">${c.enrolled >= c.capacity ? 'Full' : 'Open'}</span>
              </div>
            </div>`).join('')}
        </div>
      `;
    }

    function renderCourseDetail(container, courseId) {
      const course = state.courses.find(c => c.id == courseId);
      if (!course) { container.innerHTML = '<h1>Course not found</h1>'; return; }
      const assignments = state.assignments.filter(a => a.courseId == courseId);
      const instructor = state.users.find(u => u.id === course.instructorId);
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">${course.code}: ${course.title}</h1><button class="btn-ghost" onclick="navigateTo('courses')">Back to Courses</button></div>
        <div class="grid-2-1">
          <div class="card">
            <div class="card-header"><div class="card-title">Course Details</div></div>
            <div class="card-body">
              <p><strong>Instructor:</strong> ${instructor?.name || 'N/A'}</p>
              <p><strong>Credits:</strong> ${course.credits}</p>
              <p><strong>Description:</strong> ${course.description}</p>
              <p><strong>Syllabus:</strong> ${course.syllabus || 'No syllabus'}</p>
              ${state.currentUser.role === 'student' ? `<button class="btn-primary-custom" onclick="enrollCourse(${course.id})">${course.enrolled < course.capacity ? 'Enroll' : 'Join Waitlist'}</button>` : ''}
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">Assignments</div></div>
            <div class="card-body">
              ${assignments.length ? assignments.map(a => `
                <div class="mb-2 p-3" style="border:1px solid var(--border); border-radius:12px; cursor:pointer;" onclick="navigateTo('assignment-detail', ${a.id})">
                  <strong>${a.title}</strong><br>
                  <small>Due: ${new Date(a.dueDate).toLocaleDateString()} | Points: ${a.points}</small>
                </div>`).join('') : '<p>No assignments yet.</p>'}
            </div>
          </div>
        </div>
      `;
    }

    window.enrollCourse = function(courseId) {
      const course = state.courses.find(c => c.id == courseId);
      if (!course) return;
      if (course.enrolled < course.capacity) {
        course.enrolled++;
        persist(STORAGE_KEYS.COURSES);
        showToast('Enrolled successfully');
      } else {
        showToast('Course full, added to waitlist', 'info');
      }
      navigateTo('course-detail', courseId);
    };

    function renderAssignments(container) {
      const user = state.currentUser;
      let assignments = [];
      if (user.role === 'student') {
        const myCourseIds = state.courses.filter(c => c.enrolled > 0).map(c => c.id);
        assignments = state.assignments.filter(a => myCourseIds.includes(a.courseId));
      } else {
        assignments = state.assignments;
      }
      assignments = assignments.map(a => {
        const sub = state.submissions.find(s => s.assignmentId === a.id && s.userId === user.id);
        return { ...a, submission: sub };
      });
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Assignments</h1></div>
        <div class="card">
          <table class="data-table">
            <thead><tr><th>Title</th><th>Course</th><th>Due</th><th>Points</th><th>Status</th><th></th></tr></thead>
            <tbody>${assignments.map(a => `
              <tr>
                <td><strong>${a.title}</strong></td>
                <td>${state.courses.find(c => c.id === a.courseId)?.code}</td>
                <td>${new Date(a.dueDate).toLocaleDateString()}</td>
                <td>${a.points}</td>
                <td>${a.submission ? (a.submission.grade ? `<span class="badge badge-success">Graded: ${a.submission.grade}</span>` : '<span class="badge badge-info">Submitted</span>') : '<span class="badge badge-warning">Pending</span>'}</td>
                <td><button class="btn-ghost" onclick="navigateTo('assignment-detail', ${a.id})">View</button></td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderAssignmentDetail(container, assignmentId) {
      const assignment = state.assignments.find(a => a.id == assignmentId);
      if (!assignment) { container.innerHTML = '<h1>Assignment not found</h1>'; return; }
      const course = state.courses.find(c => c.id === assignment.courseId);
      const submission = state.submissions.find(s => s.assignmentId == assignmentId && s.userId === state.currentUser.id);
      const isLate = new Date(assignment.dueDate) < new Date();
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">${assignment.title}</h1><button class="btn-ghost" onclick="navigateTo('assignments')">Back</button></div>
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><div class="card-title">Details</div></div>
            <div class="card-body">
              <p><strong>Course:</strong> ${course?.code} – ${course?.title}</p>
              <p><strong>Due:</strong> ${new Date(assignment.dueDate).toLocaleString()}</p>
              <p><strong>Points:</strong> ${assignment.points}</p>
              <p><strong>Description:</strong> ${assignment.description || 'No description'}</p>
              ${assignment.isExam ? '<p class="badge badge-warning">Exam – proctoring required</p>' : ''}
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">${submission ? 'Your Submission' : 'Submit'}</div></div>
            <div class="card-body">
              ${submission ? `
                <p>Submitted: ${new Date(submission.submittedAt).toLocaleString()}</p>
                ${submission.grade ? `<p>Grade: ${submission.grade}/${assignment.points}</p><p>Feedback: ${submission.feedback || 'No feedback'}</p>` : '<p class="badge badge-info">Not graded yet</p>'}
                ${submission.fileUrl ? `<p>File: <a href="#">${submission.fileUrl}</a></p>` : ''}
                ${submission.text ? `<p>Text: ${submission.text.substring(0,100)}...</p>` : ''}
              ` : `
                ${isLate && assignment.latePolicy === 'not_allowed' ? '<p class="text-danger">Late submissions not allowed.</p>' : `
                  <div class="form-group">
                    <label class="form-label">Upload file (if required)</label>
                    <input type="file" id="subFile" class="form-control-custom">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Or enter text</label>
                    <textarea class="form-control-custom" id="subText" rows="4"></textarea>
                  </div>
                  <button class="btn-primary-custom" onclick="submitAssignment(${assignment.id})">Submit</button>
                `}
              `}
            </div>
          </div>
        </div>
      `;
    }

    window.submitAssignment = function(assignmentId) {
      const fileInput = document.getElementById('subFile');
      const text = document.getElementById('subText')?.value;
      const newSub = {
        id: Date.now(),
        assignmentId,
        userId: state.currentUser.id,
        fileUrl: fileInput?.files[0] ? fileInput.files[0].name : null,
        text: text || null,
        submittedAt: new Date().toISOString(),
        grade: null,
        feedback: null,
        status: 'submitted'
      };
      state.submissions.push(newSub);
      persist(STORAGE_KEYS.SUBMISSIONS);
      showToast('Assignment submitted');
      navigateTo('assignment-detail', assignmentId);
    };

    function renderGrades(container) {
      const user = state.currentUser;
      const submissions = state.submissions.filter(s => s.userId === user.id && s.grade);
      const byCourse = {};
      submissions.forEach(s => {
        const a = state.assignments.find(a => a.id === s.assignmentId);
        if (a) {
          if (!byCourse[a.courseId]) byCourse[a.courseId] = { grades: [], totalPoints: 0, earned: 0 };
          byCourse[a.courseId].grades.push(s);
          byCourse[a.courseId].totalPoints += a.points;
          byCourse[a.courseId].earned += s.grade;
        }
      });
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Grades</h1></div>
        <div class="card">
          <table class="data-table">
            <thead><tr><th>Course</th><th>Assignments Graded</th><th>Total Points</th><th>Earned</th><th>Percentage</th></tr></thead>
            <tbody>${Object.entries(byCourse).map(([cid, data]) => {
              const course = state.courses.find(c => c.id == cid);
              const pct = (data.earned / data.totalPoints * 100).toFixed(1);
              return `<tr><td><strong>${course?.code || 'Unknown'}</strong></td><td>${data.grades.length}</td><td>${data.totalPoints}</td><td>${data.earned}</td><td><span class="badge ${pct>=60?'badge-success':'badge-warning'}">${pct}%</span></td></tr>`;
            }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderAttendance(container) {
      const user = state.currentUser;
      const records = state.attendance.filter(a => a.userId === user.id);
      const byCourse = {};
      records.forEach(r => { if (!byCourse[r.courseOfferingId]) byCourse[r.courseOfferingId] = []; byCourse[r.courseOfferingId].push(r); });
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Attendance</h1></div>
        <div class="card">
          <table class="data-table">
            <thead><tr><th>Course</th><th>Date</th><th>Status</th></tr></thead>
            <tbody>${records.map(r => {
              const course = state.courses.find(c => c.id === r.courseOfferingId);
              return `<tr><td><strong>${course?.code || 'Unknown'}</strong></td><td>${new Date(r.date).toLocaleDateString()}</td><td><span class="badge ${r.status === 'present' ? 'badge-success' : r.status === 'late' ? 'badge-warning' : 'badge-danger'}">${r.status}</span></td></tr>`;
            }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderMessages(container) {
      const user = state.currentUser;
      const msgs = state.messages.filter(m => m.toUserId === user.id || m.fromUserId === user.id).sort((a,b) => new Date(b.time) - new Date(a.time));
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Messages</h1><button class="btn-primary-custom" onclick="openMessageModal()">Compose</button></div>
        <div class="card">
          ${msgs.map(m => {
            const other = state.users.find(u => u.id === (m.fromUserId === user.id ? m.toUserId : m.fromUserId));
            return `
              <div class="notif-item ${!m.read && m.toUserId === user.id ? 'unread' : ''}" onclick="openMessage(${m.id})">
                <div class="d-flex flex-column flex-grow-1">
                  <div><b>${other?.name}</b> – ${m.subject}</div>
                  <div class="notif-time">${new Date(m.time).toLocaleString()}</div>
                </div>
                ${!m.read && m.toUserId === user.id ? '<span class="badge-dot" style="position:static;"></span>' : ''}
              </div>`;
          }).join('')}
        </div>
      `;
    }

    window.openMessage = function(msgId) {
      const msg = state.messages.find(m => m.id === msgId);
      if (!msg) return;
      if (msg.toUserId === state.currentUser.id) {
        msg.read = true;
        persist(STORAGE_KEYS.MESSAGES);
      }
      openModal(msg.subject, `<p><strong>From:</strong> ${state.users.find(u=>u.id===msg.fromUserId)?.name}</p><p>${msg.body}</p>`, `<button class="btn-ghost" onclick="closeModal('genericModal')">Close</button>`);
    };

    function renderProfile(container) {
      const u = state.currentUser;
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">My Profile</h1></div>
        <div class="grid-2-1">
          <div class="card">
            <div class="card-header"><div class="card-title">Personal Information</div></div>
            <div class="card-body">
              <p><strong>Name:</strong> ${u.name}</p>
              <p><strong>Email:</strong> ${u.email}</p>
              <p><strong>Role:</strong> <span class="badge badge-lime">${u.role}</span></p>
              <p><strong>Matric No:</strong> ${u.matricNumber || 'N/A'}</p>
              <p><strong>Phone:</strong> ${u.phone || 'N/A'}</p>
              <p><strong>Last Login:</strong> ${new Date(u.lastLogin).toLocaleString()}</p>
              <button class="btn-ghost mt-2" onclick="editProfile()">Edit Profile</button>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">Preferences</div></div>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span>Email notifications</span>
                <label class="toggle-switch"><input type="checkbox" ${u.preferences?.email ? 'checked' : ''} onchange="updatePreference('email', this.checked)"><span class="toggle-track"></span></label>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <span>SMS notifications</span>
                <label class="toggle-switch"><input type="checkbox" ${u.preferences?.sms ? 'checked' : ''} onchange="updatePreference('sms', this.checked)"><span class="toggle-track"></span></label>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    window.editProfile = function() {
      openModal('Edit Profile', `
        <div class="form-group"><label class="form-label">Name</label><input class="form-control-custom" id="editName" value="${state.currentUser.name}"></div>
        <div class="form-group"><label class="form-label">Phone</label><input class="form-control-custom" id="editPhone" value="${state.currentUser.phone || ''}"></div>
      `, `<button class="btn-ghost" onclick="closeModal('genericModal')">Cancel</button><button class="btn-primary-custom" onclick="saveProfile()">Save</button>`);
    };

    window.saveProfile = function() {
      state.currentUser.name = document.getElementById('editName').value;
      state.currentUser.phone = document.getElementById('editPhone').value;
      persist(STORAGE_KEYS.CURRENT_USER);
      updateUserSidebar();
      closeModal('genericModal');
      showToast('Profile updated');
      navigateTo('profile');
    };

    function renderLiveClass(container) {
      const sessions = state.liveSessions.filter(s => {
        const course = state.courses.find(c => c.id === s.courseId);
        return course && (course.enrolled > 0 || state.currentUser.role === 'faculty');
      });
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Live Classes</h1></div>
        <div class="grid-2">
          ${sessions.map(s => `
            <div class="card">
              <div class="card-body">
                <h3>${s.title}</h3>
                <p>Course: ${state.courses.find(c=>c.id===s.courseId)?.code}</p>
                <p>Starts: ${new Date(s.startTime).toLocaleString()}</p>
                <p>Duration: ${s.duration} min</p>
                <a href="${s.joinUrl}" target="_blank" class="btn-primary-custom">Join</a>
              </div>
            </div>`).join('')}
        </div>
      `;
    }

    function renderExams(container) {
      const user = state.currentUser;
      const exams = state.assignments.filter(a => a.isExam).map(a => {
        const session = state.examSessions.find(es => es.examId === a.id && es.userId === user.id);
        return { ...a, session };
      });
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Exams</h1></div>
        <div class="card">
          <table class="data-table">
            <thead><tr><th>Title</th><th>Course</th><th>Due</th><th>Status</th><th></th></tr></thead>
            <tbody>${exams.map(e => `
              <tr>
                <td><strong>${e.title}</strong></td>
                <td>${state.courses.find(c=>c.id===e.courseId)?.code}</td>
                <td>${new Date(e.dueDate).toLocaleString()}</td>
                <td><span class="badge ${e.session ? (e.session.status === 'completed' ? 'badge-success' : 'badge-warning') : 'badge-neutral'}">${e.session ? e.session.status : 'Not started'}</span></td>
                <td><button class="btn-ghost" onclick="startExam(${e.id})">${e.session ? 'Resume' : 'Start'}</button></td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    window.startExam = function(examId) {
      const exam = state.assignments.find(a => a.id === examId);
      if (!exam) return;
      let session = state.examSessions.find(es => es.examId === examId && es.userId === state.currentUser.id);
      if (!session) {
        session = { id: Date.now(), examId, userId: state.currentUser.id, startTime: new Date().toISOString(), status: 'in_progress' };
        state.examSessions.push(session);
        persist(STORAGE_KEYS.EXAM_SESSIONS);
      }
      openModal(`Exam: ${exam.title}`, `
        <div class="mb-3"><strong>Time remaining: </strong><span id="examTimer">${exam.durationMinutes || 120}:00</span></div>
        ${exam.questions ? exam.questions.map((q,i) => `<div class="mb-3"><p>${i+1}. ${q.text}</p><textarea class="form-control-custom" placeholder="Your answer..."></textarea></div>`).join('') : '<p>No questions loaded.</p>'}
        <div class="mt-3"><button class="btn-primary-custom" onclick="submitExam(${examId})">Submit Exam</button></div>
      `, `<button class="btn-ghost" onclick="closeModal('genericModal')">Close</button>`);
      let timeLeft = (exam.durationMinutes || 120) * 60;
      const timer = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft/60);
        const seconds = timeLeft%60;
        const timerEl = document.getElementById('examTimer');
        if (timerEl) timerEl.innerText = `${minutes}:${seconds.toString().padStart(2,'0')}`;
        if (timeLeft <= 0) {
          clearInterval(timer);
          submitExam(examId);
        }
      }, 1000);
      window.submitExam = function(eId) {
        clearInterval(timer);
        const session = state.examSessions.find(es => es.examId == eId && es.userId === state.currentUser.id);
        if (session) session.status = 'completed';
        persist(STORAGE_KEYS.EXAM_SESSIONS);
        showToast('Exam submitted');
        closeModal('genericModal');
        navigateTo('exams');
      };
    };

    function renderBursary(container) {
      const payments = state.payments.filter(p => p.userId === state.currentUser.id);
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Bursary & Payments</h1></div>
        <div class="card">
          <div class="card-header"><div class="card-title">Payment History</div></div>
          <div class="card-body">
            <table class="data-table">
              <thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Status</th></tr></thead>
              <tbody>${payments.map(p => `
                <tr><td>${new Date(p.date).toLocaleDateString()}</td><td>${p.description}</td><td><strong>₦${p.amount}</strong></td><td><span class="badge badge-success">${p.status}</span></td></tr>`).join('')}
              </tbody>
            </table>
            <button class="btn-primary-custom mt-3" onclick="openPaymentModal()">Make Payment</button>
          </div>
        </div>
      `;
    }

    function renderHostel(container) {
      const apps = state.hostelApplications.filter(a => a.userId === state.currentUser.id);
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Hostel Accommodation</h1><button class="btn-primary-custom" onclick="applyHostel()">Apply</button></div>
        <div class="card">
          <table class="data-table">
            <thead><tr><th>Hostel</th><th>Room Type</th><th>Status</th><th>Allocated Room</th></tr></thead>
            <tbody>${apps.map(a => `<tr><td>${a.hostelName}</td><td>${a.roomType}</td><td><span class="badge ${a.status==='approved'?'badge-success':'badge-warning'}">${a.status}</span></td><td>${a.allocatedRoom || '-'}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    window.applyHostel = function() {
      openModal('Apply for Hostel', `
        <div class="form-group"><label class="form-label">Hostel Name</label><input class="form-control-custom" id="hostelName" value="Hall A"></div>
        <div class="form-group"><label class="form-label">Room Type</label><select class="form-control-custom" id="roomType"><option>shared</option><option>single</option></select></div>
      `, `<button class="btn-ghost" onclick="closeModal('genericModal')">Cancel</button><button class="btn-primary-custom" onclick="saveHostelApplication()">Submit</button>`);
    };

    window.saveHostelApplication = function() {
      const app = {
        id: Date.now(),
        userId: state.currentUser.id,
        hostelName: document.getElementById('hostelName').value,
        roomType: document.getElementById('roomType').value,
        status: 'pending',
        applicationDate: new Date().toISOString().split('T')[0]
      };
      state.hostelApplications.push(app);
      persist(STORAGE_KEYS.HOSTEL_APPLICATIONS);
      closeModal('genericModal');
      showToast('Application submitted');
      navigateTo('hostel');
    };

    function renderLibrary(container) {
      const resources = state.libraryResources;
      const borrowings = state.borrowingRecords.filter(b => b.userId === state.currentUser.id && !b.returnedAt);
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Library</h1></div>
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><div class="card-title">Available Resources</div></div>
            <div class="card-body">
              <table class="data-table">
                <thead><tr><th>Title</th><th>Author</th><th>Available</th><th></th></tr></thead>
                <tbody>${resources.map(r => `<tr><td><strong>${r.title}</strong></td><td>${r.author}</td><td>${r.copiesAvailable}/${r.copiesTotal}</td><td><button class="btn-ghost" onclick="borrowResource(${r.id})" ${r.copiesAvailable<1?'disabled':''}>Borrow</button></td></tr>`).join('')}
              </tbody></table>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">My Borrowings</div></div>
            <div class="card-body">
              <table class="data-table">
                <thead><tr><th>Title</th><th>Due</th><th>Fine</th><th></th></tr></thead>
                <tbody>${borrowings.map(b => {
                  const res = state.libraryResources.find(r => r.id === b.resourceId);
                  const overdue = new Date(b.dueDate) < new Date();
                  return `<tr><td>${res?.title}</td><td>${b.dueDate}${overdue?' <span class="badge badge-danger">overdue</span>':''}</td><td>₦${b.fine}</td><td><button class="btn-ghost" onclick="returnResource(${b.id})">Return</button></td></tr>`;
                }).join('')}
              </tbody>
            </div>
          </div>
        </div>
      `;
    }

    window.borrowResource = function(resId) {
      const res = state.libraryResources.find(r => r.id === resId);
      if (!res || res.copiesAvailable < 1) return;
      res.copiesAvailable--;
      const record = {
        id: Date.now(),
        userId: state.currentUser.id,
        resourceId: resId,
        borrowedAt: new Date().toISOString().split('T')[0],
        dueDate: new Date(Date.now() + 14*86400000).toISOString().split('T')[0],
        returnedAt: null,
        fine: 0
      };
      state.borrowingRecords.push(record);
      persist(STORAGE_KEYS.LIBRARY_RESOURCES);
      persist(STORAGE_KEYS.BORROWING_RECORDS);
      showToast(`Borrowed "${res.title}"`);
      navigateTo('library');
    };

    window.returnResource = function(recordId) {
      const rec = state.borrowingRecords.find(r => r.id === recordId);
      if (!rec) return;
      const res = state.libraryResources.find(r => r.id === rec.resourceId);
      if (res) res.copiesAvailable++;
      rec.returnedAt = new Date().toISOString().split('T')[0];
      if (new Date(rec.dueDate) < new Date()) {
        const daysLate = Math.floor((new Date() - new Date(rec.dueDate)) / 86400000);
        rec.fine = daysLate * 50;
        showToast(`Late return, fine ₦${rec.fine}`, 'warning');
      }
      persist(STORAGE_KEYS.LIBRARY_RESOURCES);
      persist(STORAGE_KEYS.BORROWING_RECORDS);
      navigateTo('library');
    };

    function renderCurriculum(container) {
      const prog = state.programmes.find(p => p.id === state.currentUser.programmeId);
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Curriculum</h1></div>
        <div class="card">
          <div class="card-header"><div class="card-title">Programme: ${prog?.name || 'N/A'}</div></div>
          <div class="card-body">
            <p><strong>Code:</strong> ${prog?.code}</p>
            <p><strong>Duration:</strong> ${prog?.durationYears} years</p>
            <p><strong>Requirements:</strong> ${prog?.requirements}</p>
          </div>
        </div>
      `;
    }

    function renderAutomation(container) {
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Automation Scripts & Tools</h1></div>
        <div class="grid-2">
          <div class="card">
            <div class="card-header"><div class="card-title">Database</div></div>
            <div class="card-body">
              <button class="btn-primary-custom mb-2 w-100" onclick="runAutomation('backup')">Backup Database</button>
              <button class="btn-primary-custom mb-2 w-100" onclick="runAutomation('restore')">Restore from Backup</button>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">Notifications</div></div>
            <div class="card-body">
              <button class="btn-primary-custom mb-2 w-100" onclick="runAutomation('send_reminders')">Send Assignment Reminders</button>
              <button class="btn-primary-custom mb-2 w-100" onclick="runAutomation('send_grades')">Publish Final Grades</button>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">Analytics</div></div>
            <div class="card-body">
              <button class="btn-primary-custom mb-2 w-100" onclick="runAutomation('train_model')">Train Predictive Model</button>
              <button class="btn-primary-custom mb-2 w-100" onclick="runAutomation('generate_reports')">Generate Reports</button>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">Compliance</div></div>
            <div class="card-body">
              <button class="btn-primary-custom mb-2 w-100" onclick="runAutomation('anonymize_old')">Anonymize Old Users</button>
              <button class="btn-primary-custom mb-2 w-100" onclick="runAutomation('export_gdpr')">Export All User Data</button>
            </div>
          </div>
        </div>
        <div class="card mt-3">
          <div class="card-header"><div class="card-title">Execution Log</div></div>
          <div class="card-body">
            <div class="automation-log" id="automationLog">
              ${state.automationLogs.map(l => `<div><span class="badge badge-info">${l.timestamp}</span> – ${l.script}: ${l.status}</div>`).join('')}
            </div>
          </div>
        </div>
      `;
    }

    window.runAutomation = function(script) {
      const logEntry = { timestamp: new Date().toLocaleString(), script, status: 'started' };
      state.automationLogs.unshift(logEntry);
      if (state.automationLogs.length > 50) state.automationLogs.pop();
      persist(STORAGE_KEYS.AUTOMATION_LOGS);
      showToast(`Running ${script}...`, 'info');
      setTimeout(() => {
        logEntry.status = 'completed';
        persist(STORAGE_KEYS.AUTOMATION_LOGS);
        const container = document.getElementById('page-automation');
        if (container) renderAutomation(container);
        showToast(`${script} completed`, 'success');
      }, 2000);
    };

    function renderIntegrations(container) {
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Integrations</h1></div>
        <div class="card">
          <div class="card-body">
            <p><strong>Paystack:</strong> ${state.settings.features.paystack ? '✅ Enabled' : '❌ Disabled'}</p>
            <p><strong>SendGrid:</strong> ✅ Connected</p>
            <p><strong>Twilio:</strong> ✅ Connected</p>
            <p><strong>AWS S3:</strong> ✅ Configured</p>
            <p><strong>Proctoring:</strong> ${state.settings.features.proctoring ? '✅ Enabled' : '❌ Disabled'}</p>
          </div>
        </div>
      `;
    }

    function renderSettings(container) {
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">System Settings</h1></div>
        <div class="card">
          <div class="card-header"><div class="card-title">General</div></div>
          <div class="card-body">
            <div class="d-flex justify-content-between mb-3"><span>Environment</span> <span class="badge badge-lime">${state.settings.env}</span></div>
            <div class="d-flex justify-content-between mb-3"><span>Page Size</span> <input type="number" value="${state.settings.pageSize}" class="form-control-custom" style="width:80px;" onchange="updateSetting('pageSize', this.value)"></div>
            <div class="d-flex justify-content-between align-items-center">
              <span>Debug Mode</span>
              <label class="toggle-switch"><input type="checkbox" ${state.settings.debug ? 'checked' : ''} onchange="updateSetting('debug', this.checked)"><span class="toggle-track"></span></label>
            </div>
          </div>
        </div>
      `;
    }

    window.updateSetting = function(key, val) {
      if (key === 'pageSize') val = parseInt(val);
      else if (key === 'debug') val = !!val;
      state.settings[key] = val;
      persist(STORAGE_KEYS.SETTINGS);
      showToast('Setting updated');
    };

    function renderHealth(container) {
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">System Health</h1></div>
        <div class="grid-2">
          <div class="card"><div class="card-body"><strong>CPU:</strong> 12%</div></div>
          <div class="card"><div class="card-body"><strong>Memory:</strong> 4.2/8 GB</div></div>
          <div class="card"><div class="card-body"><strong>Database:</strong> ✅ Connected</div></div>
          <div class="card"><div class="card-body"><strong>Redis:</strong> ✅ Connected</div></div>
          <div class="card"><div class="card-body"><strong>Uptime:</strong> 15 days</div></div>
        </div>
      `;
    }

    function renderGDPRExport(container) {
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">GDPR Data Export</h1></div>
        <div class="card">
          <div class="card-body">
            <p>Download all your personal data in JSON format.</p>
            <button class="btn-primary-custom" onclick="exportData()">Export My Data</button>
            <button class="btn-danger ms-2" onclick="anonymizeMe()">Anonymize My Account</button>
          </div>
        </div>
      `;
    }

    window.exportData = function() {
      const data = {
        user: state.currentUser,
        submissions: state.submissions.filter(s => s.userId === state.currentUser.id),
        payments: state.payments.filter(p => p.userId === state.currentUser.id),
        messages: state.messages.filter(m => m.toUserId === state.currentUser.id || m.fromUserId === state.currentUser.id),
        attendance: state.attendance.filter(a => a.userId === state.currentUser.id),
        borrowings: state.borrowingRecords.filter(b => b.userId === state.currentUser.id)
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `user_${state.currentUser.id}_data.json`;
      a.click();
      showToast('Data exported');
    };

    window.anonymizeMe = function() {
      if (confirm('This will anonymize your account. Are you sure?')) {
        state.currentUser.name = 'Deleted User';
        state.currentUser.email = `deleted-${state.currentUser.id}@anon.changex`;
        persist(STORAGE_KEYS.CURRENT_USER);
        showToast('Account anonymized');
        navigateTo('profile');
      }
    };

    function renderInstitutions(container) {
      if (state.currentUser.role !== 'admin') { container.innerHTML = '<h1>Access denied</h1>'; return; }
      container.innerHTML = '<h1>Institutions (Admin)</h1><p>Manage institutions here.</p>';
    }

    function renderUsers(container) {
      if (state.currentUser.role !== 'admin') { container.innerHTML = '<h1>Access denied</h1>'; return; }
      container.innerHTML = '<h1>Users (Admin)</h1><p>Manage users here.</p>';
    }

    function renderAnalytics(container) {
      container.innerHTML = '<div class="page-header"><h1 class="page-title">Analytics</h1></div><div class="card"><div class="card-body"><canvas id="gradeChart" width="400" height="200"></canvas></div></div>';
      setTimeout(() => {
        const ctx = document.getElementById('gradeChart')?.getContext('2d');
        if (ctx) {
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['CS301', 'BIO101'],
              datasets: [{
                label: 'Average Grade',
                data: [85, 42],
                backgroundColor: ['#b9f23e', '#00c9b1'],
                borderRadius: 8
              }]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });
        }
      }, 200);
    }

    // ========== NEW PAGES ==========
    function renderStaff(container) {
      const staff = state.staffProfiles.map(s => ({ ...s, user: state.users.find(u => u.id === s.userId) }));
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Faculty & Staff</h1></div>
        <div class="grid-3">
          ${staff.map(s => `
            <div class="card">
              <div class="card-body">
                <h3>${s.user?.name || 'Unknown'}</h3>
                <p>${s.title} – ${s.department}</p>
                <p><i class="bi bi-envelope"></i> ${s.email}</p>
                <p><i class="bi bi-geo-alt"></i> ${s.office}</p>
              </div>
            </div>`).join('')}
        </div>
      `;
    }

    function renderAlumni(container) {
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Alumni Network</h1></div>
        <div class="card">
          <table class="data-table">
            <thead><tr><th>Name</th><th>Graduation Year</th><th>Programme</th></tr></thead>
            <tbody>${state.alumni.map(a => `<tr><td>${a.name}</td><td>${a.graduationYear}</td><td>${a.programme}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderCalendar(container) {
      const events = state.academicCalendar.filter(e => e.institutionId === state.currentUser.institutionId);
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Academic Calendar</h1></div>
        <div class="card">
          <table class="data-table">
            <thead><tr><th>Event</th><th>Start</th><th>End</th></tr></thead>
            <tbody>${events.map(e => `<tr><td><strong>${e.event}</strong></td><td>${e.start}</td><td>${e.end}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderPolicies(container) {
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Policies & Procedures</h1></div>
        <div class="card">
          <div class="card-body">
            ${state.policies.filter(p => p.institutionId === state.currentUser.institutionId).map(p => `
              <div class="mb-3">
                <h3>${p.type}</h3>
                <p>${p.content}</p>
                <small>Version ${p.version}</small>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderAdmissions(container) {
      const apps = state.admissions.filter(a => a.userId === state.currentUser.id);
      container.innerHTML = `
        <div class="page-header"><h1 class="page-title">Admissions Status</h1></div>
        <div class="card">
          <table class="data-table">
            <thead><tr><th>Programme</th><th>Application Date</th><th>Decision</th></tr></thead>
            <tbody>${apps.map(a => {
              const prog = state.programmes.find(p => p.id === a.programmeId);
              return `<tr><td>${prog?.name}</td><td>${a.applicationDate}</td><td><span class="badge ${a.status==='accepted'?'badge-success':'badge-warning'}">${a.status}</span></td></tr>`;
            }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // ========== MODALS ==========
    window.openModal = function(title, bodyHTML, footerHTML) {
      document.getElementById('modalTitle').innerText = title;
      document.getElementById('modalBody').innerHTML = bodyHTML;
      document.getElementById('modalFooter').innerHTML = footerHTML;
      document.getElementById('genericModal').classList.add('open');
    };
    window.closeModal = function(id) { document.getElementById(id).classList.remove('open'); };

    window.openCourseModal = function() {
      openModal('Create New Course', `
        <div class="form-group"><label class="form-label">Course Code</label><input class="form-control-custom" id="courseCode"></div>
        <div class="form-group"><label class="form-label">Title</label><input class="form-control-custom" id="courseTitle"></div>
        <div class="form-group"><label class="form-label">Description</label><textarea class="form-control-custom" id="courseDesc"></textarea></div>
      `, `<button class="btn-ghost" onclick="closeModal('genericModal')">Cancel</button><button class="btn-primary-custom" onclick="createCourse()">Create</button>`);
    };

    window.createCourse = function() {
      const newCourse = {
        id: state.courses.length + 1,
        code: document.getElementById('courseCode').value,
        title: document.getElementById('courseTitle').value,
        description: document.getElementById('courseDesc').value,
        institutionId: 1,
        enrolled: 0,
        capacity: 30,
        status: 'active',
        submittedForApproval: false,
        approved: false
      };
      state.courses.push(newCourse);
      persist(STORAGE_KEYS.COURSES);
      closeModal('genericModal');
      showToast('Course created');
      navigateTo('courses');
    };

    window.openMessageModal = function() {
      openModal('Compose Message', `
        <div class="form-group"><label class="form-label">To (user ID)</label><input class="form-control-custom" id="msgTo" value="2"></div>
        <div class="form-group"><label class="form-label">Subject</label><input class="form-control-custom" id="msgSubject"></div>
        <div class="form-group"><label class="form-label">Message</label><textarea class="form-control-custom" id="msgBody"></textarea></div>
      `, `<button class="btn-ghost" onclick="closeModal('genericModal')">Cancel</button><button class="btn-primary-custom" onclick="sendMessage()">Send</button>`);
    };

    window.sendMessage = function() {
      const toId = parseInt(document.getElementById('msgTo').value);
      const newMsg = {
        id: Date.now(),
        fromUserId: state.currentUser.id,
        toUserId: toId,
        subject: document.getElementById('msgSubject').value,
        body: document.getElementById('msgBody').value,
        time: new Date().toISOString(),
        read: false
      };
      state.messages.push(newMsg);
      persist(STORAGE_KEYS.MESSAGES);
      closeModal('genericModal');
      showToast('Message sent');
    };

    window.openPaymentModal = function() {
      openModal('Make Payment', `
        <div class="form-group"><label class="form-label">Amount (₦)</label><input class="form-control-custom" id="payAmount" type="number"></div>
        <div class="form-group"><label class="form-label">Description</label><input class="form-control-custom" id="payDesc" value="Tuition Fee"></div>
      `, `<button class="btn-ghost" onclick="closeModal('genericModal')">Cancel</button><button class="btn-primary-custom" onclick="processPayment()">Pay Now</button>`);
    };

    window.processPayment = function() {
      const amount = parseFloat(document.getElementById('payAmount').value);
      const desc = document.getElementById('payDesc').value;
      const payment = {
        id: 'pay_' + Date.now(),
        userId: state.currentUser.id,
        institutionId: 1,
        amount,
        description: desc,
        status: 'completed',
        date: new Date().toISOString(),
        paystackReference: 'ref_' + Math.random().toString(36).substring(2)
      };
      state.payments.push(payment);
      persist(STORAGE_KEYS.PAYMENTS);
      closeModal('genericModal');
      showToast(`Payment of ₦${amount} successful!`);
      navigateTo('bursary');
    };

    // ========== UTILITIES ==========
    window.toggleSidebar = function() {
      if (window.innerWidth <= 900) document.getElementById('sidebar').classList.toggle('mobile-open');
      else {
        state.sidebarOpen = !state.sidebarOpen;
        document.getElementById('sidebar').classList.toggle('collapsed', !state.sidebarOpen);
        document.getElementById('mainContent').classList.toggle('expanded', !state.sidebarOpen);
        localStorage.setItem(STORAGE_KEYS.SIDEBAR, state.sidebarOpen);
      }
    };

    window.toggleTheme = function() {
      state.theme = state.theme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', state.theme);
      document.getElementById('themeBtn').innerHTML = state.theme === 'dark' ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon"></i>';
      localStorage.setItem(STORAGE_KEYS.THEME, state.theme);
    };

    window.toggleNotifPanel = function() {
      document.getElementById('notifPanel').classList.toggle('open');
      renderNotifications();
    };

    function renderNotifications() {
      const list = document.getElementById('notifList');
      const userNotes = state.notifications.filter(n => n.userId === state.currentUser?.id);
      list.innerHTML = userNotes.map(n => `
        <div class="notif-item ${n.read ? '' : 'unread'}" onclick="markNotificationRead(${n.id})">
          ${!n.read ? '<div class="notif-dot"></div>' : '<div style="width:8px;"></div>'}
          <div class="flex-grow-1"><div class="notif-text">${n.text}</div><div class="notif-time">${new Date(n.time).toLocaleString()}</div></div>
        </div>`).join('');
      document.getElementById('notifDot').style.display = userNotes.some(n => !n.read) ? 'block' : 'none';
    }

    window.markNotificationRead = function(id) {
      state.notifications = state.notifications.map(n => n.id === id ? { ...n, read: true } : n);
      persist(STORAGE_KEYS.NOTIFICATIONS);
      renderNotifications();
    };

    window.markAllNotificationsRead = function() {
      state.notifications = state.notifications.map(n => ({ ...n, read: true }));
      persist(STORAGE_KEYS.NOTIFICATIONS);
      renderNotifications();
      showToast('All notifications marked read', 'info');
    };

    window.showToast = function(message, type = 'success') {
      const icons = { success:'✅', error:'❌', warning:'⚠️', info:'ℹ️' };
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
      document.getElementById('toastContainer').appendChild(toast);
      setTimeout(() => { toast.classList.add('out'); setTimeout(() => toast.remove(), 300); }, 3200);
    };

    window.globalSearch = function(q) { showToast(`Searching for "${q}"…`, 'info'); };
    window.showHelp = function() { showToast('Help is on the way!', 'info'); };
    window.updatePreference = function(key, val) {
      state.currentUser.preferences = state.currentUser.preferences || {};
      state.currentUser.preferences[key] = val;
      persist(STORAGE_KEYS.CURRENT_USER);
      showToast('Preference updated');
    };

    function updateUserSidebar() {
      const u = state.currentUser;
      if (u) {
        document.getElementById('sidebarAvatar').innerText = u.initials || u.name.charAt(0);
        document.getElementById('sidebarName').innerText = u.name;
        document.getElementById('sidebarRole').innerText = u.role;
        document.getElementById('topbarAvatar').innerText = u.initials || u.name.charAt(0);
      }
    }

    // ========== INIT ==========
    window.addEventListener('load', () => {
      applyTheme(state.theme);
      if (!state.currentUser) {
        showLoginPage();
      } else {
        updateUserSidebar();
        renderSidebarNav();
        renderNotifications();
        navigateTo('dashboard');
      }

      setInterval(() => {
        if (state.currentUser) {
          const n = { id: Date.now(), userId: state.currentUser.id, text: 'New system notification', time: new Date().toISOString(), read: false };
          state.notifications.unshift(n);
          if (state.notifications.length > 30) state.notifications.pop();
          persist(STORAGE_KEYS.NOTIFICATIONS);
          renderNotifications();
        }
      }, 45000);
    });

    function applyTheme(t) {
      document.documentElement.setAttribute('data-theme', t);
      document.getElementById('themeBtn').innerHTML = t === 'dark' ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon"></i>';
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); document.querySelector('.topbar-search input')?.focus(); }
      if (e.key === 'Escape') { document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open')); document.getElementById('notifPanel').classList.remove('open'); }
    });
  })();
</script>
</body>
</html>
