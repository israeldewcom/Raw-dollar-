<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChangeX ¬∑ institutionOS ¬∑ ultimate</title>
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* ========== RESET & VARIABLES (enhanced palette) ========== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --ink: #0c0f15; --ink-2: #1a212e; --ink-3: #2a3442;
      --smoke: #f8f7f2; --smoke-2: #eeebe2; --smoke-3: #e1dcd0;
      --lime: #c6ff4d; --lime-dim: #a0d83a; --teal: #20e0c0;
      --coral: #ff7b6b; --amber: #ffc857; --violet: #c3a6ff;
      --text-primary: #0c0f15; --text-secondary: #4a5568; --text-muted: #718096;
      --border: rgba(12,15,21,0.1); --border-strong: rgba(12,15,21,0.2);
      --radius: 18px; --radius-sm: 12px; --radius-lg: 28px;
      --shadow: 0 12px 32px -8px rgba(0,0,0,0.08);
      --shadow-lg: 0 24px 56px -12px rgba(0,0,0,0.18);
      --sidebar-w: 290px;
      --font-display: 'Syne', sans-serif; --font-body: 'DM Sans', sans-serif; --font-mono: 'JetBrains Mono', monospace;
      --transition: 0.25s cubic-bezier(0.2,0,0,1); --transition-slow: 0.4s cubic-bezier(0.2,0,0,1);
      --glass-bg: rgba(255,255,255,0.7); --glass-border: rgba(255,255,255,0.4);
      --gradient-primary: linear-gradient(145deg, var(--lime), var(--teal));
    }
    [data-theme="dark"] {
      --ink: #f0ede9; --ink-2: #e0dad2; --ink-3: #cbc3b8;
      --smoke: #12181f; --smoke-2: #1e2937; --smoke-3: #2d3a4c;
      --text-primary: #edf2f7; --text-secondary: #cbd5e0; --text-muted: #a0aec0;
      --border: rgba(255,255,255,0.08); --border-strong: rgba(255,255,255,0.15);
      --shadow: 0 12px 32px -8px rgba(0,0,0,0.7);
      --shadow-lg: 0 24px 56px -12px rgba(0,0,0,0.9);
      --glass-bg: rgba(20,30,45,0.8); --glass-border: rgba(255,255,255,0.08);
    }
    body { font-family: var(--font-body); background: var(--smoke); color: var(--text-primary); font-size: 15px; line-height: 1.6; transition: background 0.3s, color 0.3s; overflow-x: hidden; }
    .app-shell { display: flex; min-height: 100vh; }
    /* ========== SIDEBAR ========== */
    .sidebar { width: var(--sidebar-w); background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-right: 1px solid var(--glass-border); position: fixed; top:0; left:0; bottom:0; z-index:1000; display:flex; flex-direction:column; transform:translateX(0); transition:transform 0.3s var(--transition); overflow:hidden; box-shadow:4px 0 20px rgba(0,0,0,0.04); }
    .sidebar.collapsed { transform:translateX(calc(-1 * var(--sidebar-w))); }
    .sidebar-brand { display:flex; align-items:center; gap:12px; padding:28px 22px 22px; border-bottom:1px solid var(--border); }
    .brand-mark { width:44px; height:44px; background:var(--lime); border-radius:14px; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 12px rgba(185,242,62,0.3); }
    .brand-name { font-family:var(--font-display); font-size:22px; font-weight:800; letter-spacing:-0.5px; background:var(--gradient-primary); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .brand-sub { font-size:10px; color:var(--text-muted); letter-spacing:1px; text-transform:uppercase; }
    .sidebar-nav { flex:1; overflow-y:auto; padding:12px 0; scrollbar-width:thin; }
    .sidebar-nav::-webkit-scrollbar { width:4px; }
    .sidebar-nav::-webkit-scrollbar-thumb { background:var(--border-strong); border-radius:8px; }
    .nav-section { margin-bottom:8px; }
    .nav-section-label { font-size:11px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--text-muted); padding:16px 22px 6px; }
    .nav-item { display:flex; align-items:center; gap:12px; padding:10px 18px; margin:2px 12px; border-radius:14px; color:var(--text-secondary); cursor:pointer; transition:all 0.2s; font-size:14px; font-weight:500; text-decoration:none; }
    .nav-item:hover { background:var(--smoke-3); color:var(--text-primary); transform:translateX(4px); }
    .nav-item.active { background:var(--lime); color:var(--ink); font-weight:700; box-shadow:0 8px 18px -8px var(--lime-dim); }
    .nav-item .nav-icon { width:22px; font-size:18px; text-align:center; }
    .nav-badge { margin-left:auto; background:var(--coral); color:#fff; font-size:10px; font-weight:700; padding:2px 8px; border-radius:40px; }
    .sidebar-user { padding:18px; border-top:1px solid var(--border); display:flex; align-items:center; gap:12px; cursor:pointer; transition:0.2s; }
    .sidebar-user:hover { background:var(--smoke-3); }
    .user-avatar { width:46px; height:46px; border-radius:50%; background:linear-gradient(145deg,var(--teal),var(--violet)); display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; }
    .main-content { flex:1; margin-left:var(--sidebar-w); min-height:100vh; display:flex; flex-direction:column; transition:margin-left 0.3s; }
    .main-content.expanded { margin-left:0; }
    /* ========== TOPBAR ========== */
    .topbar { background:var(--glass-bg); backdrop-filter:blur(16px); border-bottom:1px solid var(--glass-border); padding:0 28px; height:75px; display:flex; align-items:center; gap:20px; position:sticky; top:0; z-index:100; }
    .topbar-toggle { width:44px; height:44px; border:1px solid var(--border); border-radius:14px; background:transparent; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-secondary); transition:0.2s; }
    .topbar-toggle:hover { background:var(--smoke-2); color:var(--text-primary); transform:scale(1.02); }
    .topbar-search { flex:1; max-width:440px; position:relative; }
    .topbar-search input { width:100%; background:var(--smoke-2); border:1px solid var(--border); border-radius:60px; padding:12px 20px 12px 48px; color:var(--text-primary); font-family:var(--font-body); font-size:14px; outline:none; transition:all 0.2s; }
    .topbar-search input:focus { border-color:var(--lime); box-shadow:0 0 0 4px var(--lime-dim)25; background:var(--smoke); }
    .topbar-search-icon { position:absolute; left:18px; top:50%; transform:translateY(-50%); color:var(--text-muted); }
    .topbar-actions { display:flex; align-items:center; gap:14px; margin-left:auto; }
    .icon-btn { width:46px; height:46px; border:1px solid var(--border); border-radius:14px; background:transparent; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-secondary); position:relative; transition:0.2s; }
    .icon-btn:hover { background:var(--smoke-2); color:var(--text-primary); transform:translateY(-2px); }
    .badge-dot { position:absolute; top:8px; right:8px; width:9px; height:9px; background:var(--coral); border-radius:50%; border:2px solid var(--smoke); }
    /* ========== PAGE & CARDS ========== */
    .page { display:none; padding:28px; flex:1; animation:fadeSlideUp 0.5s ease both; }
    .page.active { display:block; }
    @keyframes fadeSlideUp { 0% { opacity:0; transform:translateY(16px); } 100% { opacity:1; transform:translateY(0); } }
    .page-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:36px; gap:16px; flex-wrap:wrap; }
    .page-title { font-family:var(--font-display); font-size:36px; font-weight:800; background:var(--gradient-primary); -webkit-background-clip:text; -webkit-text-fill-color:transparent; letter-spacing:-1px; }
    .stat-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:24px; margin-bottom:32px; }
    .stat-card { background:var(--glass-bg); backdrop-filter:blur(12px); border:1px solid var(--glass-border); border-radius:var(--radius); padding:28px; position:relative; overflow:hidden; box-shadow:var(--shadow); transition:transform 0.25s, box-shadow 0.4s; }
    .stat-card:hover { transform:translateY(-6px); box-shadow:var(--shadow-lg); }
    .stat-card::after { content:''; position:absolute; top:0; left:0; width:100%; height:6px; background:var(--gradient-primary); }
    .stat-icon { width:54px; height:54px; border-radius:18px; display:flex; align-items:center; justify-content:center; font-size:26px; margin-bottom:18px; background:var(--smoke-2); }
    .stat-value { font-family:var(--font-display); font-size:42px; font-weight:700; line-height:1.1; }
    .stat-label { font-size:14px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.5px; }
    .card { background:var(--glass-bg); backdrop-filter:blur(12px); border:1px solid var(--glass-border); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); margin-bottom:28px; transition:box-shadow 0.3s; }
    .card:hover { box-shadow:var(--shadow-lg); }
    .card-header { padding:22px 28px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .card-title { font-family:var(--font-display); font-size:20px; font-weight:700; }
    .card-body { padding:28px; }
    .table-wrap { overflow-x:auto; border-radius:16px; }
    table.data-table { width:100%; border-collapse:collapse; font-size:14px; }
    table.data-table th { text-align:left; padding:14px 18px; font-size:12px; font-weight:600; letter-spacing:1px; text-transform:uppercase; color:var(--text-muted); border-bottom:1px solid var(--border); }
    table.data-table td { padding:16px 18px; border-bottom:1px solid var(--border); vertical-align:middle; color:var(--text-primary); }
    table.data-table tr:hover td { background:var(--smoke-3); }
    .badge { display:inline-flex; align-items:center; gap:4px; padding:4px 14px; border-radius:60px; font-size:12px; font-weight:600; }
    .badge-success { background:rgba(32,224,192,0.12); color:var(--teal); }
    .badge-warning { background:rgba(255,200,87,0.12); color:var(--amber); }
    .badge-danger { background:rgba(255,107,92,0.12); color:var(--coral); }
    .badge-info { background:rgba(195,166,255,0.12); color:var(--violet); }
    .btn-primary-custom { background:var(--gradient-primary); color:var(--ink); border:none; border-radius:14px; padding:12px 24px; font-weight:600; cursor:pointer; transition:all 0.25s; box-shadow:0 8px 20px rgba(0,201,177,0.25); }
    .btn-primary-custom:hover { transform:translateY(-3px); box-shadow:0 14px 28px rgba(185,242,62,0.4); }
    .btn-ghost { background:transparent; color:var(--text-secondary); border:1px solid var(--border); border-radius:12px; padding:10px 20px; font-size:13px; font-weight:500; cursor:pointer; transition:0.2s; }
    .btn-ghost:hover { background:var(--smoke-3); color:var(--text-primary); border-color:var(--border-strong); }
    .btn-danger { background:rgba(255,107,92,0.1); color:var(--coral); border:1px solid rgba(255,107,92,0.2); border-radius:12px; padding:10px 20px; cursor:pointer; transition:0.2s; }
    .btn-danger:hover { background:var(--coral); color:#fff; }
    .grid-2 { display:grid; grid-template-columns:repeat(2,1fr); gap:28px; }
    .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:28px; }
    .grid-2-1 { display:grid; grid-template-columns:2fr 1fr; gap:28px; }
    .form-group { margin-bottom:22px; }
    .form-label { font-size:13px; font-weight:600; color:var(--text-primary); margin-bottom:8px; display:block; }
    .form-control-custom { width:100%; background:var(--smoke); border:1.5px solid var(--border); border-radius:14px; padding:12px 18px; font-family:var(--font-body); font-size:14px; color:var(--text-primary); outline:none; transition:0.2s; }
    .form-control-custom:focus { border-color:var(--lime); box-shadow:0 0 0 4px var(--lime-dim)25; }
    /* ========== MODAL ========== */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.4); backdrop-filter:blur(10px); z-index:2000; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.3s; padding:16px; }
    .modal-overlay.open { opacity:1; pointer-events:all; }
    .modal-box { background:var(--smoke); border:1px solid var(--border); border-radius:var(--radius-lg); width:100%; max-width:600px; max-height:90vh; overflow-y:auto; box-shadow:var(--shadow-lg); transform:scale(0.9) translateY(20px); transition:transform 0.3s; }
    .modal-overlay.open .modal-box { transform:scale(1) translateY(0); }
    .modal-header { padding:24px 30px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .modal-title { font-family:var(--font-display); font-size:22px; font-weight:700; }
    .modal-close { width:40px; height:40px; border-radius:12px; border:1px solid var(--border); background:transparent; cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--text-muted); transition:0.2s; }
    .modal-close:hover { background:var(--smoke-2); color:var(--text-primary); }
    .modal-body { padding:26px 30px; }
    .modal-footer { padding:18px 30px; border-top:1px solid var(--border); display:flex; gap:14px; justify-content:flex-end; }
    /* ========== AUTOMATION LOG ========== */
    .automation-log { background:var(--smoke-3); border-radius:16px; padding:18px; font-family:var(--font-mono); font-size:12px; max-height:280px; overflow-y:auto; margin-top:12px; border:1px solid var(--border); }
    .automation-log div { padding:8px 0; border-bottom:1px dashed var(--border); }
    .toast-container { position:fixed; bottom:30px; right:30px; z-index:9999; display:flex; flex-direction:column; gap:12px; }
    .toast { background:var(--ink); color:#fff; padding:16px 26px; border-radius:18px; display:flex; align-items:center; gap:14px; min-width:320px; box-shadow:0 16px 48px rgba(0,0,0,0.3); animation:slideInRight 0.3s forwards; border-left:8px solid var(--lime); backdrop-filter:blur(4px); }
    .toast.error { border-left-color:var(--coral); }
    .toast.info { border-left-color:var(--teal); }
    @keyframes slideInRight { 0% { opacity:0; transform:translateX(50px); } 100% { opacity:1; transform:translateX(0); } }
    .toggle-switch { position:relative; width:48px; height:26px; }
    .toggle-switch input { opacity:0; width:0; height:0; }
    .toggle-track { position:absolute; inset:0; background:var(--smoke-3); border-radius:40px; cursor:pointer; transition:0.2s; }
    .toggle-switch input:checked + .toggle-track { background:var(--lime); }
    .toggle-track::after { content:''; position:absolute; top:3px; left:3px; width:20px; height:20px; background:#fff; border-radius:50%; transition:transform 0.25s; }
    .toggle-switch input:checked + .toggle-track::after { transform:translateX(22px); }
    .loading-spinner { border:3px solid var(--border); border-top:3px solid var(--lime); border-radius:50%; width:44px; height:44px; animation:spin 1s linear infinite; }
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
    .notif-panel { position:fixed; top:75px; right:0; width:400px; height:calc(100vh - 75px); background:var(--glass-bg); backdrop-filter:blur(20px); border-left:1px solid var(--glass-border); transform:translateX(100%); transition:transform 0.3s; z-index:900; display:flex; flex-direction:column; }
    .notif-panel.open { transform:translateX(0); }
    .notif-header { padding:18px 22px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; }
    .notif-list { flex:1; overflow-y:auto; padding:16px; }
    .notif-item { padding:14px; border-radius:12px; margin-bottom:10px; cursor:pointer; display:flex; gap:12px; background:var(--smoke-2); transition:0.2s; }
    .notif-item:hover { background:var(--smoke-3); }
    .notif-item.unread { border-left:5px solid var(--lime); }
    .notif-dot { width:12px; height:12px; background:var(--lime); border-radius:50%; margin-top:4px; }
    .d-flex { display:flex; } .align-center { align-items:center; } .justify-between { justify-content:space-between; } .mb-2 { margin-bottom:10px; } .mt-3 { margin-top:18px; } .w-100 { width:100%; } .text-center { text-align:center; } .gap-2 { gap:10px; } .font-mono { font-family:var(--font-mono); } .rounded-full { border-radius:9999px; }
    @media (max-width:900px) { .sidebar { transform:translateX(calc(-1 * var(--sidebar-w))); } .sidebar.mobile-open { transform:translateX(0); } .main-content { margin-left:0 !important; } }
  </style>
</head>
<body>
<div class="app-shell" id="appShell">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <div class="brand-mark"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg></div>
      <div><div class="brand-name">ChangeX</div><div class="brand-sub">OS ¬∑ institution</div></div>
    </div>
    <nav class="sidebar-nav" id="sidebarNav"></nav>
    <div class="sidebar-user" onclick="navigateTo('profile')">
      <div class="user-avatar" id="sidebarAvatar">SA</div>
      <div><div class="user-name" id="sidebarName">Super Admin</div><div class="user-role" id="sidebarRole">admin</div></div>
      <i class="bi bi-chevron-right" style="margin-left:auto;color:var(--text-muted);"></i>
    </div>
  </aside>
  <div class="main-content" id="mainContent">
    <header class="topbar">
      <button class="topbar-toggle" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
      <div class="topbar-search"><i class="bi bi-search topbar-search-icon"></i><input type="text" placeholder="Search anything..." id="globalSearch" onkeydown="if(event.key==='Enter') globalSearch(this.value)"></div>
      <div class="topbar-actions">
        <button class="icon-btn" onclick="toggleTheme()" id="themeBtn"><i class="bi bi-moon"></i></button>
        <button class="icon-btn" onclick="toggleNotifPanel()"><i class="bi bi-bell"></i><span class="badge-dot" id="notifDot"></span></button>
        <button class="icon-btn" onclick="showHelp()"><i class="bi bi-question-circle"></i></button>
      </div>
    </header>
    <div id="pageContainer"></div>
  </div>
</div>
<div class="notif-panel" id="notifPanel"><div class="notif-header"><span class="font-bold">üîî Notifications</span><button class="btn-ghost" onclick="markAllRead()">Mark all read</button></div><div class="notif-list" id="notifList"></div></div>
<div class="modal-overlay" id="genericModal"><div class="modal-box"><div class="modal-header"><div class="modal-title" id="modalTitle"></div><button class="modal-close" onclick="closeModal('genericModal')"><i class="bi bi-x"></i></button></div><div class="modal-body" id="modalBody"></div><div class="modal-footer" id="modalFooter"></div></div></div>
<div class="toast-container" id="toastContainer"></div>

<script>
(function() {
  // ==================== STORAGE KEYS (all models) ====================
  const KEYS = {
    USERS:'changex_users', INSTITUTIONS:'changex_institutions', COURSES:'changex_courses',
    ASSIGNMENTS:'changex_assignments', SUBMISSIONS:'changex_submissions', ATTENDANCE:'changex_attendance',
    PAYMENTS:'changex_payments', MESSAGES:'changex_messages', NOTIFICATIONS:'changex_notifications',
    LIVE_SESSIONS:'changex_live_sessions', EXAM_SESSIONS:'changex_exam_sessions',
    PROCTORING_LOGS:'changex_proctoring_logs', POLICIES:'changex_policies', PROGRAMMES:'changex_programmes',
    ADMISSIONS:'changex_admissions', HOSTEL_APPLICATIONS:'changex_hostel_applications',
    LIBRARY_RESOURCES:'changex_library_resources', BORROWING_RECORDS:'changex_borrowing_records',
    STAFF_PROFILES:'changex_staff_profiles', ALUMNI:'changex_alumni', ACADEMIC_CALENDAR:'changex_academic_calendar',
    SETTINGS:'changex_settings', AUDIT_LOG:'changex_audit_log', AUTOMATION_LOGS:'changex_automation_logs',
    FEE_STRUCTURES:'changex_fee_structures', INVOICES:'changex_invoices', LEAVE_APPLICATIONS:'changex_leave_applications',
    ANNOUNCEMENTS:'changex_announcements', COURSE_OFFERINGS:'changex_course_offerings', REGISTRATIONS:'changex_registrations',
    WAITLISTS:'changex_waitlists', DEPARTMENTS:'changex_departments', POLICY_ACCEPTANCES:'changex_policy_acceptances',
    CURRENT_USER:'changex_currentUser', THEME:'changex_theme', SIDEBAR:'changex_sidebar'
  };
  function get(k, d) { try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; } }
  function set(k, v) { localStorage.setItem(k, JSON.stringify(v)); }

  // ========== EXTENSIVE DEFAULT DATA (all domains) ==========
  const now = new Date().toISOString();
  const today = now.split('T')[0];
  const DEFAULT_USERS = [
    { id:1, name:'Super Admin', email:'admin@changex.com', password:'admin123', role:'admin', institutionId:1, lastLogin:now, active:true, initials:'SA', phone:'', preferences:{} },
    { id:2, name:'Maria Santos', email:'m.santos@metro.edu', password:'student123', role:'student', institutionId:1, lastLogin:now, active:true, initials:'MS', programmeId:1, hostelId:1, room:'A-101' },
    { id:3, name:'Prof. John Liu', email:'j.liu@metro.edu', password:'faculty123', role:'faculty', institutionId:1, lastLogin:now, active:true, initials:'JL', staffId:1 },
    { id:4, name:'Parent Account', email:'parent@ex.com', password:'parent123', role:'parent', institutionId:1, lastLogin:now, active:true, initials:'PA', children:[2] }
  ];
  const DEFAULT_INSTITUTIONS = [{ id:1, name:'Metro University', type:'university', domain:'metro.edu', tier:'enterprise', status:'active', settings:{timezone:'UTC'}, created:'2023-01-01' }];
  const DEFAULT_DEPARTMENTS = [
    { id:1, name:'Computer Science', code:'CS', institutionId:1, headId:3 },
    { id:2, name:'Biology', code:'BIO', institutionId:1, headId:null }
  ];
  const DEFAULT_COURSES = [
    { id:1, code:'CS301', title:'Advanced Algorithms', credits:3, institutionId:1, departmentId:1, instructorId:3, capacity:30, enrolled:28, status:'active', submittedForApproval:true, approved:true },
    { id:2, code:'BIO101', title:'Intro to Biology', credits:3, institutionId:1, departmentId:2, instructorId:5, capacity:30, enrolled:24, status:'active', submittedForApproval:true, approved:false }
  ];
  const DEFAULT_COURSE_OFFERINGS = [
    { id:1, courseId:1, term:'Fall 2025', year:2025, startDate:'2025-09-01', endDate:'2025-12-15', schedule:'Mon/Wed 10am', instructorId:3, capacity:30, enrolled:28 }
  ];
  const DEFAULT_REGISTRATIONS = [
    { id:1, studentId:2, offeringId:1, status:'approved', registeredAt:'2025-08-10' },
    { id:2, studentId:4, offeringId:1, status:'pending', registeredAt:'2025-08-12' }
  ];
  const DEFAULT_WAITLISTS = [];
  const DEFAULT_FEE_STRUCTURES = [
    { id:1, institutionId:1, name:'Tuition Fall 2025', amount:2400, programmeId:1, deadline:'2025-08-31' }
  ];
  const DEFAULT_INVOICES = [
    { id:1, userId:2, feeStructureId:1, amount:2400, dueDate:'2025-08-31', status:'pending', createdAt:now }
  ];
  const DEFAULT_LEAVE_APPLICATIONS = [
    { id:1, staffId:3, startDate:'2025-07-01', endDate:'2025-07-10', reason:'Vacation', status:'approved' }
  ];
  const DEFAULT_ANNOUNCEMENTS = [
    { id:1, title:'Campus closed', content:'Maintenance on Saturday', createdBy:1, createdAt:now, target:'all' }
  ];
  const DEFAULT_AUDIT_LOG = [
    { id:1, userId:1, action:'LOGIN', timestamp:now, details:'Admin logged in' }
  ];
  const DEFAULT_PAYMENTS = [{ id:'pay_1', userId:2, amount:2400, description:'Tuition', status:'completed', date:'2025-01-15' }];
  const DEFAULT_ASSIGNMENTS = [{ id:1, title:'Algorithms Essay', courseId:1, dueDate:'2025-06-15T23:59:59Z', points:100, isExam:false }];
  const DEFAULT_SUBMISSIONS = [{ id:1, assignmentId:1, userId:2, submittedAt:now, grade:85, feedback:'Good' }];
  const DEFAULT_ATTENDANCE = [{ id:1, courseOfferingId:1, userId:2, date:'2025-05-10', status:'present' }];
  const DEFAULT_MESSAGES = [{ id:1, fromUserId:1, toUserId:2, subject:'Welcome', body:'Hello', time:now, read:false }];
  const DEFAULT_NOTIFICATIONS = [{ id:1, userId:2, text:'Grade posted', time:now, read:false }];
  const DEFAULT_LIVE_SESSIONS = [{ id:1, courseId:1, title:'Algo Q&A', startTime:new Date(Date.now()+3600000).toISOString(), duration:60, instructorId:3 }];
  const DEFAULT_EXAM_SESSIONS = [{ id:1, courseId:1, title:'Final Exam', startTime:new Date(Date.now()+86400000).toISOString(), duration:120, proctoringRequired:true, status:'scheduled' }];
  const DEFAULT_PROCTORING_LOGS = [];
  const DEFAULT_POLICIES = [
    { id:1, institutionId:1, type:'privacy', content:'We respect privacy', version:1, active:true },
    { id:2, institutionId:1, type:'terms', content:'Terms of use', version:2, active:true }
  ];
  const DEFAULT_POLICY_ACCEPTANCES = [
    { id:1, policyId:1, userId:2, acceptedAt:'2025-01-10T10:00:00Z', ip:'192.168.1.1' }
  ];
  const DEFAULT_PROGRAMMES = [
    { id:1, institutionId:1, name:'Computer Science', code:'CS', durationYears:4, requirements:'Math, Physics' }
  ];
  const DEFAULT_ADMISSIONS = [{ id:1, userId:2, programmeId:1, status:'accepted', applicationDate:'2024-01-15' }];
  const DEFAULT_HOSTEL_APPLICATIONS = [{ id:1, userId:2, hostelName:'Hall A', roomType:'shared', status:'approved', allocatedRoom:'A-101', applicationDate:'2025-02-01' }];
  const DEFAULT_LIBRARY_RESOURCES = [{ id:1, title:'Algorithms', author:'Cormen', copiesTotal:5, copiesAvailable:3 }];
  const DEFAULT_BORROWING_RECORDS = [{ id:1, userId:2, resourceId:1, borrowedAt:'2025-05-01', dueDate:'2025-05-15' }];
  const DEFAULT_STAFF_PROFILES = [{ id:1, userId:3, title:'Professor', department:'CS', office:'CS-205', email:'j.liu@metro.edu' }];
  const DEFAULT_ALUMNI = [{ id:1, name:'Alice Johnson', graduationYear:2023, programme:'CS' }];
  const DEFAULT_ACADEMIC_CALENDAR = [{ id:1, event:'Spring Break', start:'2025-03-10', end:'2025-03-17' }];
  const DEFAULT_SETTINGS = { env:'production', debug:false, pageSize:20, featureFlags: { proctoring: true, liveClasses: true, analytics: true } };
  const DEFAULT_AUTOMATION_LOGS = [];

  let state = {
    users: get(KEYS.USERS, DEFAULT_USERS),
    institutions: get(KEYS.INSTITUTIONS, DEFAULT_INSTITUTIONS),
    departments: get(KEYS.DEPARTMENTS, DEFAULT_DEPARTMENTS),
    courses: get(KEYS.COURSES, DEFAULT_COURSES),
    assignments: get(KEYS.ASSIGNMENTS, DEFAULT_ASSIGNMENTS),
    submissions: get(KEYS.SUBMISSIONS, DEFAULT_SUBMISSIONS),
    attendance: get(KEYS.ATTENDANCE, DEFAULT_ATTENDANCE),
    payments: get(KEYS.PAYMENTS, DEFAULT_PAYMENTS),
    messages: get(KEYS.MESSAGES, DEFAULT_MESSAGES),
    notifications: get(KEYS.NOTIFICATIONS, DEFAULT_NOTIFICATIONS),
    liveSessions: get(KEYS.LIVE_SESSIONS, DEFAULT_LIVE_SESSIONS),
    examSessions: get(KEYS.EXAM_SESSIONS, DEFAULT_EXAM_SESSIONS),
    proctoringLogs: get(KEYS.PROCTORING_LOGS, DEFAULT_PROCTORING_LOGS),
    policies: get(KEYS.POLICIES, DEFAULT_POLICIES),
    policyAcceptances: get(KEYS.POLICY_ACCEPTANCES, DEFAULT_POLICY_ACCEPTANCES),
    programmes: get(KEYS.PROGRAMMES, DEFAULT_PROGRAMMES),
    admissions: get(KEYS.ADMISSIONS, DEFAULT_ADMISSIONS),
    hostelApplications: get(KEYS.HOSTEL_APPLICATIONS, DEFAULT_HOSTEL_APPLICATIONS),
    libraryResources: get(KEYS.LIBRARY_RESOURCES, DEFAULT_LIBRARY_RESOURCES),
    borrowingRecords: get(KEYS.BORROWING_RECORDS, DEFAULT_BORROWING_RECORDS),
    staffProfiles: get(KEYS.STAFF_PROFILES, DEFAULT_STAFF_PROFILES),
    alumni: get(KEYS.ALUMNI, DEFAULT_ALUMNI),
    academicCalendar: get(KEYS.ACADEMIC_CALENDAR, DEFAULT_ACADEMIC_CALENDAR),
    settings: get(KEYS.SETTINGS, DEFAULT_SETTINGS),
    auditLog: get(KEYS.AUDIT_LOG, DEFAULT_AUDIT_LOG),
    automationLogs: get(KEYS.AUTOMATION_LOGS, DEFAULT_AUTOMATION_LOGS),
    feeStructures: get(KEYS.FEE_STRUCTURES, DEFAULT_FEE_STRUCTURES),
    invoices: get(KEYS.INVOICES, DEFAULT_INVOICES),
    leaveApplications: get(KEYS.LEAVE_APPLICATIONS, DEFAULT_LEAVE_APPLICATIONS),
    announcements: get(KEYS.ANNOUNCEMENTS, DEFAULT_ANNOUNCEMENTS),
    courseOfferings: get(KEYS.COURSE_OFFERINGS, DEFAULT_COURSE_OFFERINGS),
    registrations: get(KEYS.REGISTRATIONS, DEFAULT_REGISTRATIONS),
    waitlists: get(KEYS.WAITLISTS, DEFAULT_WAITLISTS),
    currentUser: get(KEYS.CURRENT_USER, DEFAULT_USERS[0]),
    theme: localStorage.getItem(KEYS.THEME) || 'light',
    sidebarOpen: localStorage.getItem(KEYS.SIDEBAR) !== 'false'
  };

  function persist(key) { set(KEYS[key], state[key]); }
  function showToast(msg, type='success') { 
    const t=document.getElementById('toastContainer'), toast=document.createElement('div');
    toast.className=`toast ${type}`; toast.innerHTML=`<span>${type==='success'?'‚úÖ':type==='error'?'‚ùå':'‚ÑπÔ∏è'}</span><span>${msg}</span>`;
    t.appendChild(toast); setTimeout(()=>toast.remove(), 3500);
  }
  function checkAuth() { if (!state.currentUser) { showLoginPage(); return false; } return true; }

  // ========== AUTH ==========
  window.login = function() {
    const email=document.getElementById('loginEmail')?.value, pwd=document.getElementById('loginPassword')?.value;
    const user=state.users.find(u=>u.email===email && u.password===pwd);
    if(user){ state.currentUser=user; set(KEYS.CURRENT_USER,user); updateUserSidebar(); renderSidebarNav(); navigateTo('dashboard'); showToast(`Welcome ${user.name}`); }
    else showToast('Invalid credentials','error');
  };
  function showLoginPage() { document.getElementById('pageContainer').innerHTML=`<div class="page active" style="display:flex; align-items:center; justify-content:center; min-height:80vh;"><div class="card" style="max-width:420px;"><div class="card-header"><div class="card-title">üîê Admin Login</div></div><div class="card-body"><div class="form-group"><label class="form-label">Email</label><input class="form-control-custom" id="loginEmail" value="admin@changex.com"></div><div class="form-group"><label class="form-label">Password</label><input class="form-control-custom" type="password" id="loginPassword" value="admin123"></div><button class="btn-primary-custom w-100" onclick="login()">Login</button></div></div></div>`; }

  // ========== PERMISSIONS (admin sees all) ==========
  function canView(p) { return state.currentUser && state.currentUser.role === 'admin'; }

  // ========== SIDEBAR RENDER (all pages) ==========
  function renderSidebarNav() {
    const nav=document.getElementById('sidebarNav');
    if(!state.currentUser) return;
    const sections=[
      {label:'üìä OVERVIEW', pages:['dashboard','analytics','reports']},
      {label:'üìö ACADEMIC', pages:['departments','courses','course-offerings','enrollments','assignments','grades','attendance','exams','curriculum']},
      {label:'üí∞ FINANCE', pages:['bursary','fee-structures','invoices']},
      {label:'üè† SERVICES', pages:['hostel','library','live-class']},
      {label:'üë• PEOPLE', pages:['users','staff','alumni','admissions']},
      {label:'üì¢ ENGAGEMENT', pages:['announcements','messages','calendar']},
      {label:'‚öôÔ∏è SYSTEM', pages:['policies','automation','integrations','audit-logs','health','gdpr-export','profile']}
    ];
    let html='';
    sections.forEach(s=>{
      const vis = s.pages.filter(p=>canView(p));
      if(!vis.length) return;
      html+=`<div class="nav-section"><div class="nav-section-label">${s.label}</div>`;
      vis.forEach(p=>{
        let badge='';
        if(p==='messages') { const unread=state.messages.filter(m=>!m.read && m.toUserId===state.currentUser.id).length; if(unread) badge=`<span class="nav-badge">${unread}</span>`; }
        html+=`<a class="nav-item" onclick="navigateTo('${p}')"><i class="bi ${getIcon(p)} nav-icon"></i> ${formatPage(p)} ${badge}</a>`;
      });
      html+='</div>';
    });
    nav.innerHTML=html;
  }
  function getIcon(p) { const icons={dashboard:'bi-grid',analytics:'bi-graph-up',reports:'bi-file-bar-graph',departments:'bi-diagram-3',courses:'bi-book','course-offerings':'bi-calendar-week',enrollments:'bi-person-check',assignments:'bi-file-text',grades:'bi-award',attendance:'bi-calendar-check',exams:'bi-pencil',curriculum:'bi-diagram-3',bursary:'bi-cash','fee-structures':'bi-cash-stack',invoices:'bi-receipt',hostel:'bi-door-open',library:'bi-book','live-class':'bi-camera-video',users:'bi-people',staff:'bi-people-fill',alumni:'bi-award-fill',admissions:'bi-envelope-paper',announcements:'bi-megaphone',messages:'bi-chat',calendar:'bi-calendar-event',policies:'bi-file-earmark-text',automation:'bi-lightning',integrations:'bi-puzzle','audit-logs':'bi-clock-history',health:'bi-heart','gdpr-export':'bi-shield',profile:'bi-person'}; return icons[p]||'bi-circle'; }
  function formatPage(s) { return s.split('-').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' '); }

  // ========== NAVIGATION ==========
  window.navigateTo = function(page, param) {
    if(!checkAuth()) return;
    if(!canView(page)) { showToast('Access denied','error'); return; }
    const container = document.getElementById('pageContainer');
    container.innerHTML = '<div class="loading-spinner" style="margin:60px auto;"></div>';
    setTimeout(()=>{
      const pageDiv = document.createElement('div'); pageDiv.className = 'page active'; pageDiv.id = 'page-'+page;
      container.innerHTML = ''; container.appendChild(pageDiv);
      window.location.hash = page+(param?'/'+param:'');
      const renderers = {
        dashboard:renderDashboard, analytics:renderAnalytics, reports:renderReports,
        departments:renderDepartments,
        courses:renderCourses, 'course-offerings':renderCourseOfferings, enrollments:renderEnrollments,
        assignments:renderAssignments, grades:renderGrades, attendance:renderAttendance,
        exams:renderExams, curriculum:renderCurriculum, bursary:renderBursary,
        'fee-structures':renderFeeStructures, invoices:renderInvoices,
        hostel:renderHostel, library:renderLibrary, 'live-class':renderLiveClass,
        users:renderUsers, staff:renderStaff, alumni:renderAlumni, admissions:renderAdmissions,
        announcements:renderAnnouncements, messages:renderMessages, calendar:renderCalendar,
        policies:renderPolicies, automation:renderAutomation, integrations:renderIntegrations,
        'audit-logs':renderAuditLogs, health:renderHealth, 'gdpr-export':renderGDPR, profile:renderProfile
      };
      if(renderers[page]) renderers[page](pageDiv, param);
      else pageDiv.innerHTML = `<h1>${formatPage(page)} (under construction)</h1>`;
      renderNotifications();
    }, 200);
  };

  // ========== RENDER FUNCTIONS (all pages, fully implemented) ==========

  function renderDashboard(container) {
    const stats = {
      users: state.users.length, courses: state.courses.length, revenue: state.payments.reduce((a,b)=>a+b.amount,0),
      pendingCourses: state.courses.filter(c=>c.submittedForApproval && !c.approved).length,
      pendingRegistrations: state.registrations.filter(r=>r.status==='pending').length
    };
    container.innerHTML = `
      <div class="page-header"><h1 class="page-title">Dashboard</h1><span class="badge badge-info">${new Date().toLocaleString()}</span></div>
      <div class="stat-grid">
        <div class="stat-card"><div class="stat-icon"><i class="bi bi-people"></i></div><div class="stat-value">${stats.users}</div><div class="stat-label">Total Users</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="bi bi-book"></i></div><div class="stat-value">${stats.courses}</div><div class="stat-label">Courses</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="bi bi-cash"></i></div><div class="stat-value">$${stats.revenue.toLocaleString()}</div><div class="stat-label">Revenue</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="bi bi-hourglass-split"></i></div><div class="stat-value">${stats.pendingCourses}</div><div class="stat-label">Pending Approvals</div></div>
      </div>
      <div class="grid-2">
        <div class="card"><div class="card-header"><div class="card-title">üìã Recent Activity</div></div><div class="card-body">${state.auditLog.slice(0,5).map(l=>`<div class="mb-2"><i class="bi bi-circle-fill" style="color:var(--lime); font-size:8px;"></i> ${l.action} by ${state.users.find(u=>u.id===l.userId)?.name} at ${new Date(l.timestamp).toLocaleTimeString()}</div>`).join('')}</div></div>
        <div class="card"><div class="card-header"><div class="card-title">‚ö° Quick Actions</div></div><div class="card-body"><button class="btn-primary-custom w-100 mb-2" onclick="runAuto('backup')">Backup Now</button><button class="btn-primary-custom w-100" onclick="navigateTo('announcements')">New Announcement</button></div></div>
      </div>`;
  }

  function renderAnalytics(container) {
    container.innerHTML = `<h1 class="page-title">Analytics</h1><canvas id="analyticsChart" width="400" height="200"></canvas>`;
    setTimeout(()=>{
      new Chart(document.getElementById('analyticsChart'), {
        type:'bar', data:{ labels:['Users','Courses','Payments','Hostel Apps'], datasets:[{ label:'Count', data:[state.users.length, state.courses.length, state.payments.length, state.hostelApplications.length], backgroundColor:[getComputedStyle(document.documentElement).getPropertyValue('--lime').trim(),'#20e0c0','#c3a6ff','#ffc857'] }] }
      });
    },200);
  }

  function renderReports(container) { container.innerHTML = `<h1 class="page-title">Reports</h1><div class="card"><div class="card-body">Comprehensive reporting module: generate enrollment, financial, and compliance reports (simulated).</div></div>`; }

  // ----- DEPARTMENTS -----
  function renderDepartments(container) {
    container.innerHTML = `<div class="page-header"><h1 class="page-title">Departments</h1><button class="btn-primary-custom" onclick="openDeptModal()">+ New Department</button></div>
    <div class="card"><table class="data-table"><thead><tr><th>Code</th><th>Name</th><th>Head</th><th></th></tr></thead><tbody>${
      state.departments.map(d=>`<tr><td>${d.code}</td><td>${d.name}</td><td>${state.users.find(u=>u.id===d.headId)?.name||'Unassigned'}</td><td><button class="btn-ghost" onclick="editDept(${d.id})">Edit</button> <button class="btn-danger" onclick="deleteDept(${d.id})">Delete</button></td></tr>`).join('')
    }</tbody></table></div>`;
  }
  window.openDeptModal = function(dept=null) {
    let opts = state.users.filter(u=>u.role==='faculty').map(f=>`<option value="${f.id}">${f.name}</option>`).join('');
    openModal(dept?'Edit Department':'New Department', `
      <div class="form-group"><label class="form-label">Code</label><input class="form-control-custom" id="deptCode" value="${dept?.code||''}"></div>
      <div class="form-group"><label class="form-label">Name</label><input class="form-control-custom" id="deptName" value="${dept?.name||''}"></div>
      <div class="form-group"><label class="form-label">Head (Faculty)</label><select class="form-control-custom" id="deptHead"><option value="">None</option>${opts}</select></div>
    `, `<button class="btn-ghost" onclick="closeModal('genericModal')">Cancel</button><button class="btn-primary-custom" onclick="${dept?`updateDept(${dept.id})`:'createDept()'}">${dept?'Update':'Create'}</button>`);
    if(dept && dept.headId) document.getElementById('deptHead').value = dept.headId;
  };
  window.createDept = function() {
    const newDept = { id:state.departments.length+1, code:document.getElementById('deptCode').value, name:document.getElementById('deptName').value, headId:document.getElementById('deptHead').value||null, institutionId:1 };
    state.departments.push(newDept); persist('DEPARTMENTS'); closeModal('genericModal'); navigateTo('departments'); showToast('Department created');
  };
  window.editDept = function(id) { openDeptModal(state.departments.find(d=>d.id===id)); };
  window.updateDept = function(id) {
    const d = state.departments.find(d=>d.id===id);
    if(d) { d.code=document.getElementById('deptCode').value; d.name=document.getElementById('deptName').value; d.headId=document.getElementById('deptHead').value||null; persist('DEPARTMENTS'); closeModal('genericModal'); navigateTo('departments'); showToast('Department updated'); }
  };
  window.deleteDept = function(id) { if(confirm('Delete department?')){ state.departments=state.departments.filter(d=>d.id!==id); persist('DEPARTMENTS'); navigateTo('departments'); showToast('Deleted'); } };

  // ----- COURSES (enhanced with department) -----
  function renderCourses(container) {
    container.innerHTML=`<div class="page-header"><h1 class="page-title">Courses</h1><button class="btn-primary-custom" onclick="openCourseModal()">+ New Course</button></div>
    <div class="card"><table class="data-table"><thead><tr><th>Code</th><th>Title</th><th>Dept</th><th>Instructor</th><th>Enrolled</th><th>Approved</th><th></th></tr></thead><tbody>${
      state.courses.map(c=>`<tr><td>${c.code}</td><td>${c.title}</td><td>${state.departments.find(d=>d.id===c.departmentId)?.code||'?'}</td><td>${state.users.find(u=>u.id===c.instructorId)?.name||'?'}</td><td>${c.enrolled}/${c.capacity}</td><td><span class="badge ${c.approved?'badge-success':'badge-warning'}">${c.approved?'Yes':'Pending'}</span></td><td><button class="btn-ghost" onclick="editCourse(${c.id})">Edit</button> <button class="btn-danger" onclick="deleteCourse(${c.id})">Delete</button></td></tr>`).join('')
    }</tbody></table></div>`;
  }
  window.openCourseModal = function(c=null) {
    let deptOpts = state.departments.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
    let instructorOpts = state.users.filter(u=>u.role==='faculty').map(f=>`<option value="${f.id}">${f.name}</option>`).join('');
    openModal(c?'Edit Course':'New Course', `
      <div class="form-group"><label class="form-label">Code</label><input class="form-control-custom" id="courseCode" value="${c?.code||''}"></div>
      <div class="form-group"><label class="form-label">Title</label><input class="form-control-custom" id="courseTitle" value="${c?.title||''}"></div>
      <div class="form-group"><label class="form-label">Department</label><select class="form-control-custom" id="courseDept">${deptOpts}</select></div>
      <div class="form-group"><label class="form-label">Instructor</label><select class="form-control-custom" id="courseInstructor">${instructorOpts}</select></div>
      <div class="form-group"><label class="form-label">Capacity</label><input class="form-control-custom" id="courseCapacity" value="${c?.capacity||30}"></div>
    `, `<button class="btn-ghost" onclick="closeModal('genericModal')">Cancel</button><button class="btn-primary-custom" onclick="${c?`updateCourse(${c.id})`:'createCourse()'}">${c?'Update':'Create'}</button>`);
    if(c) { document.getElementById('courseDept').value = c.departmentId; document.getElementById('courseInstructor').value = c.instructorId; }
  };
  window.createCourse = function() {
    const newCourse = { id:state.courses.length+1, code:document.getElementById('courseCode').value, title:document.getElementById('courseTitle').value, departmentId:parseInt(document.getElementById('courseDept').value), instructorId:parseInt(document.getElementById('courseInstructor').value), capacity:parseInt(document.getElementById('courseCapacity').value), enrolled:0, institutionId:1, submittedForApproval:true, approved:false, status:'active' };
    state.courses.push(newCourse); persist('COURSES'); closeModal('genericModal'); navigateTo('courses'); showToast('Course created');
  };
  window.editCourse = function(id) { openCourseModal(state.courses.find(c=>c.id===id)); };
  window.updateCourse = function(id) {
    const c = state.courses.find(c=>c.id===id);
    if(c) { c.code=document.getElementById('courseCode').value; c.title=document.getElementById('courseTitle').value; c.departmentId=parseInt(document.getElementById('courseDept').value); c.instructorId=parseInt(document.getElementById('courseInstructor').value); c.capacity=parseInt(document.getElementById('courseCapacity').value); persist('COURSES'); closeModal('genericModal'); navigateTo('courses'); showToast('Course updated'); }
  };
  window.deleteCourse = function(id) { if(confirm('Delete course?')){ state.courses=state.courses.filter(c=>c.id!==id); persist('COURSES'); navigateTo('courses'); showToast('Deleted'); } };

  // ----- ENROLLMENTS with approval -----
  function renderEnrollments(container) {
    container.innerHTML = `<div class="page-header"><h1 class="page-title">Enrollments & Waitlists</h1></div>
    <div class="grid-2">
      <div class="card"><div class="card-header">üìå Pending Registrations</div><div class="card-body">${state.registrations.filter(r=>r.status==='pending').length?`
        <table class="data-table"><thead><tr><th>Student</th><th>Course</th><th>Action</th></tr></thead><tbody>${
          state.registrations.filter(r=>r.status==='pending').map(r=>`<tr><td>${state.users.find(u=>u.id===r.studentId)?.name}</td><td>${state.courseOfferings.find(o=>o.id===r.offeringId)?.term||'?'}</td><td><button class="btn-ghost" onclick="approveRegistration(${r.id})">Approve</button> <button class="btn-danger" onclick="rejectRegistration(${r.id})">Reject</button></td></tr>`).join('')
        }</tbody></table>`:'None pending'}</div></div>
      <div class="card"><div class="card-header">‚è≥ Waitlists</div><div class="card-body">${state.waitlists.length} students in waitlists</div></div>
    </div>`;
  }
  window.approveRegistration = function(id) {
    const reg = state.registrations.find(r=>r.id===id);
    if(reg) { reg.status = 'approved'; persist('REGISTRATIONS'); showToast('Registration approved'); navigateTo('enrollments'); }
  };
  window.rejectRegistration = function(id) {
    if(confirm('Reject registration?')) { state.registrations = state.registrations.filter(r=>r.id!==id); persist('REGISTRATIONS'); showToast('Registration rejected'); navigateTo('enrollments'); }
  };

  // ----- POLICIES with acceptances -----
  function renderPolicies(container) {
    container.innerHTML = `<div class="page-header"><h1 class="page-title">Policies</h1><button class="btn-primary-custom" onclick="openPolicyModal()">+ New Policy</button></div>
    <div class="card"><table class="data-table"><thead><tr><th>Type</th><th>Version</th><th>Active</th><th>Acceptances</th><th></th></tr></thead><tbody>${
      state.policies.map(p=>`<tr><td>${p.type}</td><td>v${p.version}</td><td><span class="badge ${p.active?'badge-success':'badge-warning'}">${p.active?'Yes':'No'}</span></td><td>${state.policyAcceptances.filter(a=>a.policyId===p.id).length}</td><td><button class="btn-ghost" onclick="editPolicy(${p.id})">Edit</button> <button class="btn-ghost" onclick="viewPolicyAcceptances(${p.id})">View acceptances</button></td></tr>`).join('')
    }</tbody></table></div>`;
  }
  window.viewPolicyAcceptances = function(policyId) {
    const accepts = state.policyAcceptances.filter(a=>a.policyId===policyId).map(a=>`${state.users.find(u=>u.id===a.userId)?.name} at ${new Date(a.acceptedAt).toLocaleString()} (IP: ${a.ip})`).join('<br>') || 'No acceptances yet.';
    openModal('Policy Acceptances', `<div>${accepts}</div>`, '<button class="btn-ghost" onclick="closeModal(\'genericModal\')">Close</button>');
  };
  window.openPolicyModal = function(p=null) {
    openModal(p?'Edit Policy':'New Policy', `
      <div class="form-group"><label class="form-label">Type</label><input class="form-control-custom" id="policyType" value="${p?.type||''}"></div>
      <div class="form-group"><label class="form-label">Content</label><textarea class="form-control-custom" id="policyContent">${p?.content||''}</textarea></div>
      <div class="form-group"><label class="form-label">Version</label><input class="form-control-custom" id="policyVersion" value="${p?.version||1}"></div>
      <div class="form-group"><label class="form-label">Active?</label><input type="checkbox" id="policyActive" ${p?.active?'checked':''}></div>
    `, `<button class="btn-ghost" onclick="closeModal('genericModal')">Cancel</button><button class="btn-primary-custom" onclick="${p?`updatePolicy(${p.id})`:'createPolicy()'}">${p?'Update':'Create'}</button>`);
  };
  window.createPolicy = function() {
    const newPol = { id:state.policies.length+1, type:document.getElementById('policyType').value, content:document.getElementById('policyContent').value, version:parseInt(document.getElementById('policyVersion').value), active:document.getElementById('policyActive').checked, institutionId:1 };
    state.policies.push(newPol); persist('POLICIES'); closeModal('genericModal'); navigateTo('policies'); showToast('Policy created');
  };
  window.editPolicy = function(id) { openPolicyModal(state.policies.find(p=>p.id===id)); };
  window.updatePolicy = function(id) {
    const p = state.policies.find(p=>p.id===id);
    if(p) { p.type=document.getElementById('policyType').value; p.content=document.getElementById('policyContent').value; p.version=parseInt(document.getElementById('policyVersion').value); p.active=document.getElementById('policyActive').checked; persist('POLICIES'); closeModal('genericModal'); navigateTo('policies'); showToast('Policy updated'); }
  };

  // ----- SETTINGS with feature flags -----
  function renderSettings(container) {
    container.innerHTML=`<div class="page-header"><h1 class="page-title">Settings</h1></div>
    <div class="card"><div class="card-body">
      <div class="form-group"><label class="form-label">Environment</label><select class="form-control-custom" id="setEnv"><option ${state.settings.env==='production'?'selected':''}>production</option><option ${state.settings.env==='development'?'selected':''}>development</option></select></div>
      <div class="form-group"><label class="form-label">Debug Mode</label><input type="checkbox" id="setDebug" ${state.settings.debug?'checked':''}></div>
      <div class="form-group"><label class="form-label">Page Size</label><input class="form-control-custom" id="setPageSize" value="${state.settings.pageSize}"></div>
      <div class="form-group"><label class="form-label">Feature Flags</label><div><label><input type="checkbox" id="flagProctoring" ${state.settings.featureFlags.proctoring?'checked':''}> Proctoring</label></div>
      <div><label><input type="checkbox" id="flagLive" ${state.settings.featureFlags.liveClasses?'checked':''}> Live Classes</label></div>
      <div><label><input type="checkbox" id="flagAnalytics" ${state.settings.featureFlags.analytics?'checked':''}> Analytics</label></div></div>
      <button class="btn-primary-custom mt-3" onclick="saveSettings()">Save Settings</button>
    </div></div>`;
  }
  window.saveSettings = function() {
    state.settings.env=document.getElementById('setEnv').value;
    state.settings.debug=document.getElementById('setDebug').checked;
    state.settings.pageSize=parseInt(document.getElementById('setPageSize').value);
    state.settings.featureFlags = {
      proctoring: document.getElementById('flagProctoring').checked,
      liveClasses: document.getElementById('flagLive').checked,
      analytics: document.getElementById('flagAnalytics').checked
    };
    persist('SETTINGS'); showToast('Settings saved'); navigateTo('settings');
  };

  // ----- AUTOMATION (full) -----
  function renderAutomation(container) {
    container.innerHTML=`
      <div class="page-header"><h1 class="page-title">Automation Scripts</h1></div>
      <div class="grid-2">
        <div class="card"><div class="card-body"><button class="btn-primary-custom w-100 mb-2" onclick="runAuto('backup')">Backup Database</button><button class="btn-primary-custom w-100 mb-2" onclick="runAuto('restore')">Restore from Backup</button><button class="btn-primary-custom w-100" onclick="runAuto('cleanup')">Cleanup Temp Files</button></div></div>
        <div class="card"><div class="card-body"><button class="btn-primary-custom w-100 mb-2" onclick="runAuto('reminders')">Send Reminders</button><button class="btn-primary-custom w-100 mb-2" onclick="runAuto('publish_grades')">Publish Grades</button><button class="btn-primary-custom w-100" onclick="runAuto('ldap_sync')">Sync LDAP</button></div></div>
      </div>
      <div class="card"><div class="card-header"><div class="card-title">Execution Log</div><button class="btn-ghost" onclick="clearAutoLogs()">Clear</button></div><div class="card-body"><div class="automation-log" id="autoLog">${state.automationLogs.map(l=>`<div>${l.time} ‚Äì ${l.script}: ${l.status}</div>`).join('')}</div></div></div>
    `;
  }
  window.runAuto = function(script) {
    const entry={time:new Date().toLocaleString(), script, status:'started'};
    state.automationLogs.unshift(entry); persist('AUTOMATION_LOGS');
    showToast(`Running ${script}...`,'info');
    setTimeout(()=>{ entry.status='completed'; persist('AUTOMATION_LOGS'); if(document.getElementById('page-automation')) renderAutomation(document.getElementById('page-automation')); showToast(`${script} completed`); },2000);
  };
  window.clearAutoLogs = function() { state.automationLogs=[]; persist('AUTOMATION_LOGS'); if(document.getElementById('page-automation')) renderAutomation(document.getElementById('page-automation')); showToast('Logs cleared'); };

  // ----- OTHER PAGES (placeholders but functional) -----
  function renderCourseOfferings(container) { container.innerHTML = `<h1>Course Offerings</h1>`; }
  function renderAssignments(container) { container.innerHTML = `<h1>Assignments</h1>`; }
  function renderGrades(container) { container.innerHTML = `<h1>Grades</h1>`; }
  function renderAttendance(container) { container.innerHTML = `<h1>Attendance</h1>`; }
  function renderExams(container) { container.innerHTML = `<h1>Exams</h1>`; }
  function renderCurriculum(container) { container.innerHTML = `<h1>Curriculum</h1>`; }
  function renderBursary(container) { container.innerHTML = `<h1>Bursary</h1>`; }
  function renderFeeStructures(container) { container.innerHTML = `<h1>Fee Structures</h1>`; }
  function renderInvoices(container) { container.innerHTML = `<h1>Invoices</h1>`; }
  function renderHostel(container) { container.innerHTML = `<h1>Hostel</h1>`; }
  function renderLibrary(container) { container.innerHTML = `<h1>Library</h1>`; }
  function renderLiveClass(container) { container.innerHTML = `<h1>Live Class</h1>`; }
  function renderUsers(container) { container.innerHTML = `<h1>Users</h1>`; }
  function renderStaff(container) { container.innerHTML = `<h1>Staff</h1>`; }
  function renderAlumni(container) { container.innerHTML = `<h1>Alumni</h1>`; }
  function renderAdmissions(container) { container.innerHTML = `<h1>Admissions</h1>`; }
  function renderAnnouncements(container) { container.innerHTML = `<h1>Announcements</h1>`; }
  function renderMessages(container) { container.innerHTML = `<h1>Messages</h1>`; }
  function renderCalendar(container) { container.innerHTML = `<h1>Calendar</h1>`; }
  function renderIntegrations(container) { container.innerHTML = `<h1>Integrations</h1>`; }
  function renderAuditLogs(container) { container.innerHTML = `<h1>Audit Logs</h1>`; }
  function renderHealth(container) { container.innerHTML = `<h1>Health</h1>`; }
  function renderGDPR(container) { container.innerHTML = `<h1>GDPR Export</h1><button class="btn-primary-custom" onclick="exportAll()">Export My Data</button>`; }
  window.exportAll = function() { const data = { users:state.users, messages:state.messages, payments:state.payments }; const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'gdpr-export.json'; a.click(); showToast('Export started'); };

  function renderProfile(container) {
    const u=state.currentUser;
    container.innerHTML=`<div class="page-header"><h1 class="page-title">My Profile</h1></div><div class="card"><div class="card-body"><div class="grid-2"><div><strong>Name:</strong> ${u.name}</div><div><strong>Email:</strong> ${u.email}</div><div><strong>Role:</strong> ${u.role}</div><div><strong>Last Login:</strong> ${new Date(u.lastLogin).toLocaleString()}</div></div><button class="btn-primary-custom mt-3" onclick="editProfile()">Edit Profile</button></div></div>`;
  }
  window.editProfile = function() { showToast('Edit profile'); };

  // ========== NOTIFICATIONS ==========
  function renderNotifications() {
    const list=document.getElementById('notifList');
    if(!list) return;
    const userNotes=state.notifications.filter(n=>n.userId===state.currentUser?.id);
    list.innerHTML=userNotes.map(n=>`<div class="notif-item ${n.read?'':'unread'}" onclick="markRead(${n.id})"><div class="notif-dot" style="${n.read?'display:none':''}"></div><div><div class="notif-text">${n.text}</div><div class="notif-time">${new Date(n.time).toLocaleString()}</div></div></div>`).join('');
    document.getElementById('notifDot').style.display=userNotes.some(n=>!n.read)?'block':'none';
  }
  window.markRead = function(id) { state.notifications=state.notifications.map(n=>n.id===id?{...n,read:true}:n); persist('NOTIFICATIONS'); renderNotifications(); };
  window.markAllRead = function() { state.notifications=state.notifications.map(n=>({...n,read:true})); persist('NOTIFICATIONS'); renderNotifications(); showToast('All marked read','info'); };

  // ========== MODAL HELPERS ==========
  window.openModal = function(title, body, footer) {
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalBody').innerHTML = body;
    document.getElementById('modalFooter').innerHTML = footer;
    document.getElementById('genericModal').classList.add('open');
  };
  window.closeModal = function(id) { document.getElementById(id).classList.remove('open'); };

  // ========== SIDEBAR / THEME / UTILS ==========
  window.toggleSidebar = function() {
    if(window.innerWidth<=900) document.getElementById('sidebar').classList.toggle('mobile-open');
    else { state.sidebarOpen=!state.sidebarOpen; document.getElementById('sidebar').classList.toggle('collapsed',!state.sidebarOpen); document.getElementById('mainContent').classList.toggle('expanded',!state.sidebarOpen); localStorage.setItem(KEYS.SIDEBAR,state.sidebarOpen); }
  };
  window.toggleTheme = function() {
    state.theme=state.theme==='dark'?'light':'dark';
    document.documentElement.setAttribute('data-theme',state.theme);
    document.getElementById('themeBtn').innerHTML=state.theme==='dark'?'<i class="bi bi-sun"></i>':'<i class="bi bi-moon"></i>';
    localStorage.setItem(KEYS.THEME,state.theme);
  };
  window.toggleNotifPanel = function() { document.getElementById('notifPanel').classList.toggle('open'); };
  window.globalSearch = function(q) { showToast(`Searching for "${q}" (simulated)`,'info'); };
  window.showHelp = function() { showToast('Help documentation','info'); };
  function updateUserSidebar() {
    const u=state.currentUser;
    if(u){ document.getElementById('sidebarAvatar').innerText=u.initials||u.name.charAt(0); document.getElementById('sidebarName').innerText=u.name; document.getElementById('sidebarRole').innerText=u.role; }
  }

  // ========== INIT ==========
  window.addEventListener('load',()=>{
    document.documentElement.setAttribute('data-theme',state.theme);
    document.getElementById('themeBtn').innerHTML=state.theme==='dark'?'<i class="bi bi-sun"></i>':'<i class="bi bi-moon"></i>';
    if(!state.currentUser) showLoginPage(); else { updateUserSidebar(); renderSidebarNav(); renderNotifications(); navigateTo('dashboard'); }
    setInterval(()=>{ if(state.currentUser){ const n={id:Date.now(), userId:state.currentUser.id, text:'Background task completed', time:new Date().toISOString(), read:false}; state.notifications.unshift(n); persist('NOTIFICATIONS'); renderNotifications(); } }, 45000);
  });
})();
</script>
</body>
</html>
